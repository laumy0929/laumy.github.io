<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>端侧部署YOLOv5模型 - Laumy的技术栈</title>
    <link rel="stylesheet" href="/assets/style.css">
    <!-- MathJax支持LaTeX数学公式 -->
    <script>
      window.MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']],
          displayMath: [['$$', '$$'], ['\\[', '\\]']],
          processEscapes: true,
          processEnvironments: true
        },
        options: {
          ignoreHtmlClass: 'tex2jax_ignore',
          processHtmlClass: 'tex2jax_process'
        }
      };
    </script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  </head>
  <body>
    <header class="site-header">
      <div class="container">
        <a class="logo" href="/">Laumy的技术栈</a>
        <div class="search">
          <input id="search-input" type="text" placeholder="输入关键词回车搜索">
        </div>
        <div class="theme-toggle" title="切换主题" id="theme-toggle">☾</div>
        <nav class="top-nav">
          <div class="nav-item"><a href="/">首页</a></div>
        </nav>
      </div>
    </header>

    <main class="container layout">
      <aside class="left-nav">
        
        <div class="card">
          <div class="card-title">文章目录</div>
          <nav id="toc"><ul><li><a href="#onnx">导出 ONNX模型</a><ul></ul></li><li><a href="#_1">模型裁剪</a><ul></ul></li><li><a href="#_2">创建端侧转换环境</a><ul></ul></li><li><a href="#_3">模型转换</a><ul><li><a href="#_4">创建目录</a></li><li><a href="#_5">模型导入</a></li><li><a href="#yml">前后处理配置文件yml</a></li><li><a href="#_6">量化</a></li><li><a href="#_7">推理</a></li></ul></li><li><a href="#_8">导出模型</a><ul></ul></li><li><a href="#_9">端侧部署</a><ul></ul></li></ul></nav>
        </div>
        
      </aside>

      <section class="content">
        
<article class="card post">
  <h1>端侧部署YOLOv5模型</h1>
  <div class="meta">2025-06-10 · ai</div>
  <div class="post-content"><h2 id="onnx">导出 ONNX模型</h2>
<div class="codehilite"><pre><span></span><code><span class="n">python</span><span class="w"> </span><span class="k">export</span><span class="p">.</span><span class="n">py</span><span class="w"> </span><span class="o">--</span><span class="n">weights</span><span class="w"> </span><span class="n">runs</span><span class="o">/</span><span class="n">train</span><span class="o">/</span><span class="n">exp2</span><span class="o">/</span><span class="n">weights</span><span class="o">/</span>
</code></pre></div>
<p><a href="https://www.laumy.tech/wp-content/uploads/2025/06/wp_editor_md_204850277dfc6d569f66e9aa21b23bb8.jpg"><img alt="" src="/assets/doc/04-ai/ai应用/端侧部署yolov5模型/images/wp_editor_md_204850277dfc6d569f66e9aa21b23bb8.jpg"/></a></p>
<p>NPU不支持动态输入，使用onnxim工具进行转换为固定输入，先安装onnxsim工具。</p>
<div class="codehilite"><pre><span></span><code><span class="n">pip</span><span class="w"> </span><span class="n">install</span><span class="w"> </span><span class="n">onnxsim</span><span class="w"> </span><span class="o">-</span><span class="n">i</span><span class="w"> </span><span class="n">https</span><span class="o">:</span><span class="c1">//pypi.doubanio.com/simple/</span>
</code></pre></div>
<p>接着进行转换</p>
<div class="codehilite"><pre><span></span><code><span class="n">python</span><span class="w"> </span><span class="o">-</span><span class="n">m</span><span class="w"> </span><span class="n">onnxsim</span><span class="w"> </span><span class="n">runs</span><span class="o">/</span><span class="n">train</span><span class="o">/</span><span class="n">exp2</span><span class="o">/</span><span class="n">weights</span><span class="o">/</span><span class="n">best</span><span class="p">.</span><span class="n">onnx</span><span class="w"> </span><span class="n">yolov5s</span><span class="o">-</span><span class="n">sim</span><span class="p">.</span><span class="n">onnx</span><span class="w"> </span><span class="o">--</span><span class="n">input</span><span class="o">-</span><span class="n">shape</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">640</span><span class="p">,</span><span class="mi">640</span>
</code></pre></div>
<p><a href="https://www.laumy.tech/wp-content/uploads/2025/06/wp_editor_md_ea7893169d1f48385714ef2b59c52b9f.jpg"><img alt="" src="/assets/doc/04-ai/ai应用/端侧部署yolov5模型/images/wp_editor_md_ea7893169d1f48385714ef2b59c52b9f.jpg"/></a></p>
<h2 id="_1">模型裁剪</h2>
<p>在实际端侧中，NPU端量化的后处理运算不适合使用uint8量化，一般使用float的混合量化，但这样相对麻烦，本文示例将后处理放在CPU测进行，所以我们需要把下图中的后处理部分裁剪掉。</p>
<p><a href="https://www.laumy.tech/wp-content/uploads/2025/06/wp_editor_md_912f3659d4fdc5d416d47ff6baaab1d6.jpg"><img alt="" src="/assets/doc/04-ai/ai应用/端侧部署yolov5模型/images/wp_editor_md_912f3659d4fdc5d416d47ff6baaab1d6.jpg"/></a></p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="nn">onnx</span>

<span class="n">onnx</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">extract_model</span><span class="p">(</span><span class="s1">'./yolov5s-mask.onnx'</span><span class="p">,</span> <span class="s1">'./yolov5s-mask-rt.onnx'</span><span class="p">,</span> <span class="p">[</span><span class="s1">'images'</span><span class="p">],</span> <span class="p">[</span><span class="s1">'/model.24/Reshape_output_0'</span><span class="p">,</span><span class="s1">'/model.24/Reshape_8_output_0'</span><span class="p">,</span><span class="s1">'/model.24/Reshape_16_output_0'</span><span class="p">])</span>
</code></pre></div>
<p>使用上面的python可以进行裁剪，输入为[images]，输出为3个节点，下面是最后一个节点的示例截图。实际要根据模型文件进行调整。</p>
<p><a href="https://www.laumy.tech/wp-content/uploads/2025/06/wp_editor_md_398cdff8891facce4e9792034e484b3e.jpg"><img alt="" src="/assets/doc/04-ai/ai应用/端侧部署yolov5模型/images/wp_editor_md_398cdff8891facce4e9792034e484b3e.jpg"/></a></p>
<div class="codehilite"><pre><span></span><code><span class="n">python</span> <span class="n">extrat</span><span class="o">-</span><span class="n">mask</span><span class="o">.</span><span class="n">py</span>
</code></pre></div>
<p>接着使用上面的命令，就输出了裁剪后的模型yolov5s-mask-rt.onnx。</p>
<p>如果原生的模型没有将后处理裁剪，输入输出如下：</p>
<p><a href="https://www.laumy.tech/wp-content/uploads/2025/06/wp_editor_md_536eed1da0196527a022d65b605d69bb.jpg"><img alt="" src="/assets/doc/04-ai/ai应用/端侧部署yolov5模型/images/wp_editor_md_536eed1da0196527a022d65b605d69bb.jpg"/></a></p>
<p>输出的tensor[1,25200,85],其中25200=3x(20x20+40x40+80x80),即3个特征图一共25200个先验框。</p>
<p>原生模型使用裁剪后使用netron.app打开得到输入输出如下：</p>
<p><a href="https://www.laumy.tech/wp-content/uploads/2025/06/wp_editor_md_273c5744ce6189572f1d0233c1273dd6.jpg"><img alt="" src="/assets/doc/04-ai/ai应用/端侧部署yolov5模型/images/wp_editor_md_273c5744ce6189572f1d0233c1273dd6.jpg"/></a></p>
<p>YOLOv5模型参数含义详细解释如下：</p>
<ul>
<li>模型名称: 表示模型或图结构的名称，此处为从主图结构中提取的名称。</li>
<li>输入参数：float32[1,3,640,640]，表示输入张量的数据类型和维度。1表示一次处理的样本，3为通道数，输入的高宽均为640，此前YOLOv3是416。</li>
<li>输出参数：有3个输出张量。 -- /model.24/Reshape_output_0：表示8倍降采样率，输出为float32[1,3,85,80,80]，网格划分为80x80，每个网格有3给先验框，每个先验框预测包含85个元素（坐标4、置信度1、类别80）。 -- /model.24/Reshape_8_output_0：float32[1,3,85,40,40]，网格尺寸为40x40。 -- /model.24/Reshape_16_output_0：float32[1,3,85,20,20]，网格尺寸为20x20。</li>
<li>模型参数数量：parameter参数为7225908，表示模型中参数的总数，这是模型复杂度和计算资源需求的重要指标。</li>
</ul>
<p>再来看看此次针对口罩微调后裁剪后的模型输入输出，使用netron.app打开得到输入输出如下：</p>
<p><a href="https://www.laumy.tech/wp-content/uploads/2025/06/wp_editor_md_f6090e15493eaf08309507f2f45ee2e1.jpg"><img alt="" src="/assets/doc/04-ai/ai应用/端侧部署yolov5模型/images/wp_editor_md_f6090e15493eaf08309507f2f45ee2e1.jpg"/></a></p>
<p>上图可以看到，网格划分、先验框数量是一样的，不一样的是预测的元素为8（坐标4，置信度1，类别3）。</p>
<h2 id="_2">创建端侧转换环境</h2>
<div class="codehilite"><pre><span></span><code><span class="n">sudo</span><span class="w"> </span><span class="n">docker</span><span class="w"> </span><span class="n">images</span>
<span class="n">sudo</span><span class="w"> </span><span class="n">docker</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="o">--</span><span class="n">ipc</span><span class="o">=</span><span class="n">host</span><span class="w"> </span><span class="o">-</span><span class="n">itd</span><span class="w"> </span><span class="o">-</span><span class="n">v</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">xxx</span><span class="o">/</span><span class="n">ai</span><span class="o">/</span><span class="n">docker_data</span><span class="o">:/</span><span class="n">workspace</span><span class="w"> </span><span class="o">--</span><span class="n">name</span><span class="w"> </span><span class="n">laumy_npu_v1</span><span class="mf">.8</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="n">ubuntu</span><span class="o">-</span><span class="n">npu</span><span class="o">:</span><span class="n">v1</span><span class="mf">.8.11</span><span class="w"> </span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">bash</span>
<span class="n">sudo</span><span class="w"> </span><span class="n">docker</span><span class="w"> </span><span class="n">ps</span><span class="w"> </span><span class="o">-</span><span class="n">a</span>
<span class="n">sudo</span><span class="w"> </span><span class="n">docker</span><span class="w"> </span><span class="n">exec</span><span class="w"> </span><span class="o">-</span><span class="n">it</span><span class="w"> </span><span class="mf">55f</span><span class="mi">9</span><span class="n">cd9eb15e</span><span class="w"> </span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">bash</span>
</code></pre></div>
<p>在进行端侧部署前，需要准备量化环境，这里直接使用的是docker环境。</p>
<h2 id="_3">模型转换</h2>
<h3 id="_4">创建目录</h3>
<div class="codehilite"><pre><span></span><code><span class="o">|--</span> <span class="n">data</span>
<span class="o">|</span>   <span class="o">|--</span> <span class="n">maksssksksss0</span><span class="o">.</span><span class="n">png</span>
<span class="o">|</span>   <span class="o">|--</span> <span class="n">maksssksksss1</span><span class="o">.</span><span class="n">png</span>
<span class="o">|</span>   <span class="o">|--</span> <span class="n">maksssksksss10</span><span class="o">.</span><span class="n">png</span>
<span class="o">|</span>   <span class="o">|--</span> <span class="n">maksssksksss11</span><span class="o">.</span><span class="n">png</span>
<span class="o">|</span>   <span class="o">|--</span> <span class="n">maksssksksss12</span><span class="o">.</span><span class="n">png</span>
<span class="o">|</span>   <span class="o">|--</span> <span class="n">maksssksksss13</span><span class="o">.</span><span class="n">png</span>
<span class="o">|</span>   <span class="o">|--</span> <span class="n">maksssksksss14</span><span class="o">.</span><span class="n">png</span>
<span class="o">|</span>   <span class="o">|--</span> <span class="n">maksssksksss15</span><span class="o">.</span><span class="n">png</span>
<span class="o">|</span>   <span class="o">|--</span> <span class="n">maksssksksss16</span><span class="o">.</span><span class="n">png</span>
<span class="o">|</span>   <span class="o">|--</span> <span class="n">maksssksksss17</span><span class="o">.</span><span class="n">png</span>
<span class="o">|</span>   <span class="o">|--</span> <span class="n">maksssksksss18</span><span class="o">.</span><span class="n">png</span>
<span class="o">|</span>   <span class="o">|--</span> <span class="n">maksssksksss19</span><span class="o">.</span><span class="n">png</span>
<span class="o">|</span>   <span class="o">|--</span> <span class="n">maksssksksss2</span><span class="o">.</span><span class="n">png</span>
<span class="o">|</span>   <span class="o">|--</span> <span class="n">maksssksksss3</span><span class="o">.</span><span class="n">png</span>
<span class="o">|</span>   <span class="o">|--</span> <span class="n">maksssksksss4</span><span class="o">.</span><span class="n">png</span>
<span class="o">|</span>   <span class="o">|--</span> <span class="n">maksssksksss5</span><span class="o">.</span><span class="n">png</span>
<span class="o">|</span>   <span class="o">|--</span> <span class="n">maksssksksss6</span><span class="o">.</span><span class="n">png</span>
<span class="o">|</span>   <span class="o">|--</span> <span class="n">maksssksksss7</span><span class="o">.</span><span class="n">png</span>
<span class="o">|</span>   <span class="o">|--</span> <span class="n">maksssksksss8</span><span class="o">.</span><span class="n">png</span>
<span class="o">|</span>   <span class="err">`</span><span class="o">--</span> <span class="n">maksssksksss9</span><span class="o">.</span><span class="n">png</span>
<span class="o">|--</span> <span class="n">dataset</span><span class="o">.</span><span class="n">txt</span>
<span class="err">`</span><span class="o">--</span> <span class="n">yolov5s</span><span class="o">-</span><span class="n">mask</span><span class="o">-</span><span class="n">rt</span><span class="o">.</span><span class="n">onnx</span>
</code></pre></div>
<p>准备数据量化的数据data、数据配置dataset.txt（内容如下）、裁剪的模型yolov5s-mask-rt.onnx。</p>
<div class="codehilite"><pre><span></span><code><span class="o">./</span><span class="n">data</span><span class="o">/</span><span class="n">maksssksksss0</span><span class="o">.</span><span class="n">png</span>
<span class="o">./</span><span class="n">data</span><span class="o">/</span><span class="n">maksssksksss1</span><span class="o">.</span><span class="n">png</span>
<span class="o">./</span><span class="n">data</span><span class="o">/</span><span class="n">maksssksksss2</span><span class="o">.</span><span class="n">png</span>
<span class="o">./</span><span class="n">data</span><span class="o">/</span><span class="n">maksssksksss3</span><span class="o">.</span><span class="n">png</span>
<span class="o">./</span><span class="n">data</span><span class="o">/</span><span class="n">maksssksksss4</span><span class="o">.</span><span class="n">png</span>
<span class="o">./</span><span class="n">data</span><span class="o">/</span><span class="n">maksssksksss5</span><span class="o">.</span><span class="n">png</span>
<span class="o">./</span><span class="n">data</span><span class="o">/</span><span class="n">maksssksksss6</span><span class="o">.</span><span class="n">png</span>
<span class="o">./</span><span class="n">data</span><span class="o">/</span><span class="n">maksssksksss7</span><span class="o">.</span><span class="n">png</span>
<span class="o">./</span><span class="n">data</span><span class="o">/</span><span class="n">maksssksksss8</span><span class="o">.</span><span class="n">png</span>
<span class="o">./</span><span class="n">data</span><span class="o">/</span><span class="n">maksssksksss9</span><span class="o">.</span><span class="n">png</span>
<span class="o">./</span><span class="n">data</span><span class="o">/</span><span class="n">maksssksksss10</span><span class="o">.</span><span class="n">png</span>
<span class="o">./</span><span class="n">data</span><span class="o">/</span><span class="n">maksssksksss11</span><span class="o">.</span><span class="n">png</span>
<span class="o">./</span><span class="n">data</span><span class="o">/</span><span class="n">maksssksksss12</span><span class="o">.</span><span class="n">png</span>
<span class="o">./</span><span class="n">data</span><span class="o">/</span><span class="n">maksssksksss13</span><span class="o">.</span><span class="n">png</span>
<span class="o">./</span><span class="n">data</span><span class="o">/</span><span class="n">maksssksksss14</span><span class="o">.</span><span class="n">png</span>
<span class="o">./</span><span class="n">data</span><span class="o">/</span><span class="n">maksssksksss15</span><span class="o">.</span><span class="n">png</span>
<span class="o">./</span><span class="n">data</span><span class="o">/</span><span class="n">maksssksksss16</span><span class="o">.</span><span class="n">png</span>
<span class="o">./</span><span class="n">data</span><span class="o">/</span><span class="n">maksssksksss17</span><span class="o">.</span><span class="n">png</span>
<span class="o">./</span><span class="n">data</span><span class="o">/</span><span class="n">maksssksksss18</span><span class="o">.</span><span class="n">png</span>
<span class="o">./</span><span class="n">data</span><span class="o">/</span><span class="n">maksssksksss19</span><span class="o">.</span><span class="n">png</span>
</code></pre></div>
<h3 id="_5">模型导入</h3>
<div class="codehilite"><pre><span></span><code><span class="n">pegasus</span> <span class="kn">import</span> <span class="nn">onnx</span> <span class="o">--</span><span class="n">model</span> <span class="n">yolov5s</span><span class="o">-</span><span class="n">mask</span><span class="o">-</span><span class="n">rt</span><span class="o">.</span><span class="n">onnx</span> <span class="o">--</span><span class="n">output</span><span class="o">-</span><span class="n">data</span> <span class="n">yolov5s</span><span class="o">-</span><span class="n">mask</span><span class="o">-</span><span class="n">rt</span><span class="o">.</span><span class="n">data</span> <span class="o">--</span><span class="n">output</span><span class="o">-</span><span class="n">model</span> <span class="n">yolov5s</span><span class="o">-</span><span class="n">mask</span><span class="o">-</span><span class="n">rt</span><span class="o">.</span><span class="n">json</span>
</code></pre></div>
<p>模型导入将输出yolov5s-mask-rt.json和yolov5s-mask-rt.data文件。前者为后期量化需要的网络结构文件，后者为模型网络权重文件。</p>
<h3 id="yml">前后处理配置文件yml</h3>
<div class="codehilite"><pre><span></span><code><span class="n">生成前处理配置文件</span>
<span class="n">pegasus</span> <span class="n">generate</span> <span class="n">inputmeta</span> <span class="o">--</span><span class="n">model</span> <span class="n">yolov5s</span><span class="o">-</span><span class="n">mask</span><span class="o">-</span><span class="n">rt</span><span class="o">.</span><span class="n">json</span> <span class="o">--</span><span class="nb">input</span><span class="o">-</span><span class="n">meta</span><span class="o">-</span><span class="n">output</span> <span class="n">yolov5s</span><span class="o">-</span><span class="n">mask</span><span class="o">-</span><span class="n">rt_inputmeta</span><span class="o">.</span><span class="n">yml</span>

<span class="n">生成后处理配置文件</span><span class="err">，</span><span class="n">因为后处理是在cpu上处理并且我们已经裁剪掉了onn模型的后处理</span><span class="err">，</span><span class="n">可以不生成</span><span class="err">。</span>
<span class="n">pegasus</span> <span class="n">generate</span> <span class="n">postprocess</span><span class="o">-</span><span class="n">file</span> <span class="o">--</span><span class="n">model</span> <span class="n">yolov5s</span><span class="o">-</span><span class="n">mask</span><span class="o">-</span><span class="n">rt</span><span class="o">.</span><span class="n">json</span> <span class="o">--</span><span class="n">postprocess</span><span class="o">-</span><span class="n">file</span><span class="o">-</span><span class="n">output</span> <span class="n">yolov5s</span><span class="o">-</span><span class="n">mask</span><span class="o">-</span><span class="n">rt_postprocess_file</span><span class="o">.</span><span class="n">yml</span>
</code></pre></div>
<p>上面根据模型网络结构文件yolov5s-mask-rt.json转化生成后续量化需要的前处理和后处理描述文件，格式为yml格式。</p>
<div class="codehilite"><pre><span></span><code><span class="n">input_meta</span><span class="p">:</span>
  <span class="n">databases</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">path</span><span class="p">:</span> <span class="n">dataset</span><span class="o">.</span><span class="n">txt</span> <span class="c1">#表示模型量化需要的数据描述文件</span>
    <span class="nb">type</span><span class="p">:</span> <span class="n">TEXT</span>
    <span class="n">ports</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">lid</span><span class="p">:</span> <span class="n">images_205</span>  <span class="c1">#表示输入节点名称。</span>
      <span class="n">category</span><span class="p">:</span> <span class="n">image</span>
      <span class="n">dtype</span><span class="p">:</span> <span class="n">float32</span>
      <span class="n">sparse</span><span class="p">:</span> <span class="n">false</span>
      <span class="n">tensor_name</span><span class="p">:</span>
      <span class="n">layout</span><span class="p">:</span> <span class="n">nchw</span> <span class="c1">#输入数据的排列格式，n表示batch，c表示channel，h表示高，w表示宽</span>
      <span class="n">shape</span><span class="p">:</span>  <span class="c1">#模型输入的形状</span>
      <span class="o">-</span> <span class="mi">1</span>     <span class="c1">#输入数据的batch，如果后面量化的batch参数不为1，需要改这里。</span>
      <span class="o">-</span> <span class="mi">3</span>
      <span class="o">-</span> <span class="mi">640</span>
      <span class="o">-</span> <span class="mi">640</span>
      <span class="n">fitting</span><span class="p">:</span> <span class="n">scale</span>
      <span class="n">preprocess</span><span class="p">:</span>
        <span class="n">reverse_channel</span><span class="p">:</span> <span class="n">true</span>
        <span class="n">mean</span><span class="p">:</span>
        <span class="o">-</span> <span class="mi">0</span>
        <span class="o">-</span> <span class="mi">0</span>
        <span class="o">-</span> <span class="mi">0</span>
        <span class="n">scale</span><span class="p">:</span>  <span class="c1">#3通道的缩放值，yolov5s需要改为0.00392157</span>
        <span class="o">-</span> <span class="mf">1.0</span>
        <span class="o">-</span> <span class="mf">1.0</span>
        <span class="o">-</span> <span class="mf">1.0</span>
        <span class="n">preproc_node_params</span><span class="p">:</span>
          <span class="n">add_preproc_node</span><span class="p">:</span> <span class="n">false</span> <span class="c1">#是否添加预处理节点，用于格式转化和裁剪，这里要改为true</span>
          <span class="n">preproc_type</span><span class="p">:</span> <span class="n">IMAGE_RGB</span> <span class="c1">#预处理输入的格式</span>
          <span class="n">preproc_image_size</span><span class="p">:</span>
          <span class="o">-</span> <span class="mi">640</span>
          <span class="o">-</span> <span class="mi">640</span>
          <span class="n">preproc_crop</span><span class="p">:</span>
            <span class="n">enable_preproc_crop</span><span class="p">:</span> <span class="n">false</span>
            <span class="n">crop_rect</span><span class="p">:</span>
            <span class="o">-</span> <span class="mi">0</span>
            <span class="o">-</span> <span class="mi">0</span>
            <span class="o">-</span> <span class="mi">640</span>
            <span class="o">-</span> <span class="mi">640</span>
          <span class="n">preproc_perm</span><span class="p">:</span>
          <span class="o">-</span> <span class="mi">0</span>
          <span class="o">-</span> <span class="mi">1</span>
          <span class="o">-</span> <span class="mi">2</span>
          <span class="o">-</span> <span class="mi">3</span>
      <span class="n">redirect_to_output</span><span class="p">:</span> <span class="n">false</span>
</code></pre></div>
<p>对于模型的输入yml，需要将scale修改为0.00392157，同时默认使用cpu预处理图像，所以add_preproc_node设置为true。</p>
<h3 id="_6">量化</h3>
<div class="codehilite"><pre><span></span><code><span class="n">pegasus</span> <span class="n">quantize</span> <span class="o">--</span><span class="n">model</span> <span class="n">yolov5s</span><span class="o">-</span><span class="n">mask</span><span class="o">-</span><span class="n">rt</span><span class="o">.</span><span class="n">json</span> <span class="o">--</span><span class="n">model</span><span class="o">-</span><span class="n">data</span> <span class="n">yolov5s</span><span class="o">-</span><span class="n">mask</span><span class="o">-</span><span class="n">rt</span><span class="o">.</span><span class="n">data</span> <span class="o">--</span><span class="n">device</span> <span class="n">CPU</span> <span class="o">--</span><span class="n">iterations</span><span class="o">=</span><span class="mi">12</span> <span class="o">--</span><span class="k">with</span><span class="o">-</span><span class="nb">input</span><span class="o">-</span><span class="n">meta</span> <span class="n">yolov5s</span><span class="o">-</span><span class="n">mask</span><span class="o">-</span><span class="n">rt_inputmeta</span><span class="o">.</span><span class="n">yml</span> <span class="o">--</span><span class="n">rebuild</span> <span class="o">--</span><span class="n">model</span><span class="o">-</span><span class="n">quantize</span> <span class="n">yolov5s</span><span class="o">-</span><span class="n">mask</span><span class="o">-</span><span class="n">rt</span><span class="o">.</span><span class="n">quantize</span> <span class="o">--</span><span class="n">quantizer</span> <span class="n">asymmetric_affine</span> <span class="o">--</span><span class="n">qtype</span> <span class="n">uint8</span>
</code></pre></div>
<p>下面是量化模型的参数解析：</p>
<ul>
<li>model： 模型的网络结构文件</li>
<li>model-data：模型需要的权重文件</li>
<li>with-input-meta：模型需要前处理配置文件</li>
<li>model-quantize： 输出的模型文件</li>
<li>iterations： 模型量化使用的数据量，设置1（默认）使用dataset第一条数据。若设置20，会先遍历dataset.txt中的20行数据。</li>
<li>qtype:量化数据类型，有int8,uint8,int16等。</li>
<li>batch_size: 量化多少轮，如果不为1，需要改输入的yml文件shape，先用默认。</li>
</ul>
<p>量化后，会生成量化文件yolov5s-mask-rt.quantize。</p>
<h3 id="_7">推理</h3>
<div class="codehilite"><pre><span></span><code><span class="n">pegasus</span> <span class="n">inference</span> <span class="o">--</span><span class="n">model</span> <span class="n">yolov5s</span><span class="o">-</span><span class="n">mask</span><span class="o">-</span><span class="n">rt</span><span class="o">.</span><span class="n">json</span> <span class="o">--</span><span class="n">model</span><span class="o">-</span><span class="n">data</span> <span class="n">yolov5s</span><span class="o">-</span><span class="n">mask</span><span class="o">-</span><span class="n">rt</span><span class="o">.</span><span class="n">data</span> <span class="o">--</span><span class="n">dtype</span> <span class="n">quantized</span> <span class="o">--</span><span class="n">model</span><span class="o">-</span><span class="n">quantize</span> <span class="n">yolov5s</span><span class="o">-</span><span class="n">mask</span><span class="o">-</span><span class="n">rt</span><span class="o">.</span><span class="n">quantize</span> <span class="o">--</span><span class="n">device</span> <span class="n">CPU</span> <span class="o">--</span><span class="k">with</span><span class="o">-</span><span class="nb">input</span><span class="o">-</span><span class="n">meta</span> <span class="n">yolov5s</span><span class="o">-</span><span class="n">mask</span><span class="o">-</span><span class="n">rt_inputmeta</span><span class="o">.</span><span class="n">yml</span> <span class="o">--</span><span class="n">postprocess</span><span class="o">-</span><span class="n">file</span> <span class="n">yolov5s</span><span class="o">-</span><span class="n">mask</span><span class="o">-</span><span class="n">rt_postprocess_file</span><span class="o">.</span><span class="n">yml</span>
</code></pre></div>
<p>模型推理是为了验证量化后的模型效果，这步可省略。</p>
<h2 id="_8">导出模型</h2>
<div class="codehilite"><pre><span></span><code><span class="n">pegasus</span> <span class="n">export</span> <span class="n">ovxlib</span> <span class="o">--</span><span class="n">model</span> <span class="n">yolov5s</span><span class="o">-</span><span class="n">mask</span><span class="o">-</span><span class="n">rt</span><span class="o">.</span><span class="n">json</span> <span class="o">--</span><span class="n">model</span><span class="o">-</span><span class="n">data</span> <span class="n">yolov5s</span><span class="o">-</span><span class="n">mask</span><span class="o">-</span><span class="n">rt</span><span class="o">.</span><span class="n">data</span> <span class="o">--</span><span class="n">dtype</span> <span class="n">quantized</span> <span class="o">--</span><span class="n">model</span><span class="o">-</span><span class="n">quantize</span> <span class="n">yolov5s</span><span class="o">-</span><span class="n">mask</span><span class="o">-</span><span class="n">rt</span><span class="o">.</span><span class="n">quantize</span> <span class="o">--</span><span class="n">save</span><span class="o">-</span><span class="n">fused</span><span class="o">-</span><span class="n">graph</span> <span class="o">--</span><span class="n">target</span><span class="o">-</span><span class="n">ide</span><span class="o">-</span><span class="n">project</span> <span class="s1">'linux64'</span> <span class="o">--</span><span class="k">with</span><span class="o">-</span><span class="nb">input</span><span class="o">-</span><span class="n">meta</span> <span class="n">yolov5s</span><span class="o">-</span><span class="n">mask</span><span class="o">-</span><span class="n">rt_inputmeta</span><span class="o">.</span><span class="n">yml</span> <span class="o">--</span><span class="n">output</span><span class="o">-</span><span class="n">path</span> <span class="n">ovxilb</span><span class="o">/</span><span class="n">yolov5s</span><span class="o">-</span><span class="n">mask</span><span class="o">-</span><span class="n">rt</span><span class="o">/</span><span class="n">yolov5s</span><span class="o">-</span><span class="n">simprj</span> <span class="o">--</span><span class="n">pack</span><span class="o">-</span><span class="n">nbg</span><span class="o">-</span><span class="n">unify</span> <span class="o">--</span><span class="n">postprocess</span><span class="o">-</span><span class="n">file</span> <span class="n">yolov5s</span><span class="o">-</span><span class="n">mask</span><span class="o">-</span><span class="n">rt_postprocess_file</span><span class="o">.</span><span class="n">yml</span> <span class="o">--</span><span class="n">optimize</span> <span class="s2">"VIP9000PICO_PID0XEE"</span> <span class="o">--</span><span class="n">viv</span><span class="o">-</span><span class="n">sdk</span> <span class="err">$</span><span class="p">{</span><span class="n">VIV_SDK</span><span class="p">}</span>
</code></pre></div>
<p>模型导出，最终会生成ovxilb/yolov5s-mask-rt_nbg_unify/network_binary.nb</p>
<h2 id="_9">端侧部署</h2>
<p>修改端侧后处理的分类名和数量配置文件。</p>
<p><a href="https://www.laumy.tech/wp-content/uploads/2025/06/wp_editor_md_5f4b81653bc04ec9b411b91dcdf27e11.jpg"><img alt="" src="/assets/doc/04-ai/ai应用/端侧部署yolov5模型/images/wp_editor_md_5f4b81653bc04ec9b411b91dcdf27e11.jpg"/></a></p>
<p>改完之后，执行./build_linux.sh -t \编译生成端侧的应用，将可执行应用推到设备端。</p>
<div class="codehilite"><pre><span></span><code><span class="o">./</span><span class="n">yolov5</span> <span class="o">-</span><span class="n">b</span> <span class="n">network_binary</span><span class="o">.</span><span class="n">nb</span> <span class="o">-</span><span class="n">i</span> <span class="n">mask</span><span class="o">-</span><span class="n">test</span><span class="o">.</span><span class="n">jpeg</span> 
<span class="n">model_file</span><span class="o">=</span><span class="n">network_binary</span><span class="o">.</span><span class="n">nb</span><span class="p">,</span> <span class="nb">input</span><span class="o">=</span><span class="n">mask</span><span class="o">-</span><span class="n">test</span><span class="o">.</span><span class="n">jpeg</span><span class="p">,</span> <span class="n">loop_count</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">malloc_mbyte</span><span class="o">=</span><span class="mi">10</span> 
<span class="nb">input</span>  <span class="mi">0</span> <span class="n">dim</span> <span class="mi">3</span> <span class="mi">640</span> <span class="mi">640</span> <span class="mi">1</span><span class="p">,</span> <span class="n">data_format</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">quant_format</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="nb">input</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">none</span><span class="o">-</span><span class="n">quant</span>
<span class="n">output</span> <span class="mi">0</span> <span class="n">dim</span> <span class="mi">80</span> <span class="mi">80</span> <span class="mi">8</span> <span class="mi">3</span><span class="p">,</span> <span class="n">data_format</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">uid_20000_sub_uid_1_out_0</span><span class="p">,</span> <span class="n">none</span><span class="o">-</span><span class="n">quant</span>
<span class="n">output</span> <span class="mi">1</span> <span class="n">dim</span> <span class="mi">40</span> <span class="mi">40</span> <span class="mi">8</span> <span class="mi">3</span><span class="p">,</span> <span class="n">data_format</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">uid_20001_sub_uid_1_out_0</span><span class="p">,</span> <span class="n">none</span><span class="o">-</span><span class="n">quant</span>
<span class="n">output</span> <span class="mi">2</span> <span class="n">dim</span> <span class="mi">20</span> <span class="mi">20</span> <span class="mi">8</span> <span class="mi">3</span><span class="p">,</span> <span class="n">data_format</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">uid_20002_sub_uid_1_out_0</span><span class="p">,</span> <span class="n">none</span><span class="o">-</span><span class="n">quant</span>
<span class="n">nbg</span> <span class="n">name</span><span class="o">=</span><span class="n">network_binary</span><span class="o">.</span><span class="n">nb</span><span class="p">,</span> <span class="n">size</span><span class="p">:</span> <span class="mf">7196096.</span> 
<span class="n">create</span> <span class="n">network</span> <span class="mi">0</span><span class="p">:</span> <span class="mi">35626</span> <span class="n">us</span><span class="o">.</span>
<span class="n">prepare</span> <span class="n">network</span><span class="p">:</span> <span class="mi">38972</span> <span class="n">us</span><span class="o">.</span>
<span class="n">buffer</span> <span class="n">ptr</span><span class="p">:</span> <span class="mh">0xb6996000</span><span class="p">,</span> <span class="n">buffer</span> <span class="n">size</span><span class="p">:</span> <span class="mi">1228800</span> 
<span class="n">feed</span> <span class="nb">input</span> <span class="n">cost</span><span class="p">:</span> <span class="mi">94526</span> <span class="n">us</span><span class="o">.</span>
<span class="n">network</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="n">loop</span> <span class="n">count</span><span class="p">:</span> <span class="mi">1</span>
<span class="n">run</span> <span class="n">time</span> <span class="k">for</span> <span class="n">this</span> <span class="n">network</span> <span class="mi">0</span><span class="p">:</span> <span class="mi">119081</span> <span class="n">us</span><span class="o">.</span>
<span class="n">detection</span> <span class="n">num</span><span class="p">:</span> <span class="mi">1</span>
 <span class="mi">1</span><span class="p">:</span>  <span class="mi">94</span><span class="o">%</span><span class="p">,</span> <span class="p">[</span> <span class="mi">316</span><span class="p">,</span>  <span class="mi">228</span><span class="p">,</span>  <span class="mi">541</span><span class="p">,</span>  <span class="mi">460</span><span class="p">],</span> <span class="mi">1</span>
<span class="n">draw</span> <span class="n">objects</span> <span class="n">time</span> <span class="p">:</span> <span class="mi">154</span> <span class="n">ms</span>
<span class="n">destory</span> <span class="n">npu</span> <span class="n">finished</span><span class="o">.</span> 
<span class="o">~</span><span class="n">NpuUint</span><span class="o">.</span>
</code></pre></div>
<p><a href="https://www.laumy.tech/wp-content/uploads/2025/06/wp_editor_md_5888255c6594bac75274ffe703f05daa.jpg"><img alt="" src="/assets/doc/04-ai/ai应用/端侧部署yolov5模型/images/wp_editor_md_5888255c6594bac75274ffe703f05daa.jpg"/></a></p>
<p>参考：</p>
<ol>
<li><a href="https://v853.docs.aw-ol.com/en/npu/dev_npu/">https://v853.docs.aw-ol.com/en/npu/dev_npu/</a></li>
<li><a href="https://blog.csdn.net/weixin_42904656/article/details/127768309">https://blog.csdn.net/weixin_42904656/article/details/127768309</a></li>
</ol></div>
  <div class="post-nav">
    <a class="prev" href="/yolov5端侧部署代码分析.html">← YOLOv5端侧部署代码分析</a>
    <a class="next" href="/云服务器搭建yolov5训练环境.html">云服务器搭建YOLOv5训练环境 →</a>
  </div>
</article>

      </section>

      <aside class="right-panel">
        
      </aside>
    </main>

    <footer class="site-footer">
      <div class="container">Copyright ©2022-2025 laumy 版权所有</div>
    </footer>

    <script src="/assets/site.js"></script>
  </body>
  </html>

