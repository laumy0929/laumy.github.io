<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>YOLOv5端侧部署代码分析 - Laumy的技术栈</title>
    <link rel="stylesheet" href="assets/style.css">
    <!-- MathJax支持LaTeX数学公式 -->
    <script>
      window.MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']],
          displayMath: [['$$', '$$'], ['\\[', '\\]']],
          processEscapes: true,
          processEnvironments: true
        },
        options: {
          ignoreHtmlClass: 'tex2jax_ignore',
          processHtmlClass: 'tex2jax_process'
        }
      };
    </script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  </head>
  <body>
    <header class="site-header">
      <div class="container">
        <a class="logo" href="./">Laumy的技术栈</a>
        <div class="search">
          <input id="search-input" type="text" placeholder="输入关键词回车搜索">
        </div>
        <div class="theme-toggle" title="切换主题" id="theme-toggle">☾</div>
        <nav class="top-nav">
          <div class="nav-item"><a href="./">首页</a></div>
          <div class="nav-item site-link">
            <a href="https://www.laumy.tech" target="_blank" title="访问主站">主站点:www.laumy.tech</a>
          </div>
        </nav>
      </div>
    </header>

    <main class="container layout">
      <aside class="left-nav">
        
        <div class="card">
          <div class="card-title">文章目录</div>
          <nav id="toc"><ul><li><a href="#_1">模型流程</a><ul></ul></li><li><a href="#_2">模型输入预处理</a><ul></ul></li><li><a href="#_3">模型后处理</a><ul><li><a href="#_4">计算先验框矩形坐标</a></li><li><a href="#_5">非极大值抑制</a></li><li><a href="#_6">绘制目标框</a></li></ul></li><li><a href="#opencv">opencv参考函数</a><ul></ul></li></ul></nav>
        </div>
        
      </aside>

      <section class="content">
        
<article class="card post">
  <h1>YOLOv5端侧部署代码分析</h1>
  <div class="meta">
    <span class="meta-item">
      <i class="icon">🕒</i>
      2025-06-12
    </span>
    <span class="meta-item">
      <i class="icon">📂</i>
      ai
    </span>
    <span class="meta-item">
      <i class="icon">👤</i>
      laumy
    </span>
  </div>
  <div class="post-content"><h2 id="_1">模型流程</h2>
<div class="codehilite"><pre><span></span><code><span class="mf">1.</span><span class="w"> </span><span class="n">NPU初始化</span>
<span class="n">NpuUint</span><span class="w"> </span><span class="n">npu_uint</span><span class="p">;</span>
<span class="kt">int</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">npu_uint</span><span class="p">.</span><span class="n">npu_init</span><span class="p">();</span>

<span class="mf">2.</span><span class="n">根据传入的模型文件</span><span class="err">，</span><span class="n">创建网络</span>
<span class="n">NetworkItem</span><span class="w"> </span><span class="n">yolov5</span><span class="p">;</span>
<span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">yolov5</span><span class="p">.</span><span class="n">network_create</span><span class="p">(</span><span class="n">model_file</span><span class="p">,</span><span class="w"> </span><span class="n">network_id</span><span class="p">);</span>
<span class="w">    </span><span class="n">vip_create_network</span><span class="p">()</span>
<span class="w">    </span><span class="n">network_create_io_buffer</span><span class="p">()</span><span class="c1">//创建输入buffer</span>

<span class="mf">3.</span><span class="w"> </span><span class="n">准备和验证网络的配置</span><span class="err">，</span><span class="n">进行运行前的准备</span>
<span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">yolov5</span><span class="p">.</span><span class="n">network_prepare</span><span class="p">();</span>

<span class="mf">4.</span><span class="w"> </span><span class="n">获取输入的buffer</span><span class="err">，</span><span class="n">buffer在步骤2中创建的的</span><span class="err">。</span>
<span class="n">yolov5</span><span class="p">.</span><span class="n">get_network_input_buff_info</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">input_buffer_ptr</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">input_buffer_size</span><span class="p">);</span>
<span class="n">yolov5_preprocess_no_copy</span><span class="p">(</span><span class="n">input_file</span><span class="p">,</span><span class="w"> </span><span class="n">input_buffer_ptr</span><span class="p">,</span><span class="w"> </span><span class="n">input_buffer_size</span><span class="p">);</span>
<span class="w">    </span><span class="n">get_input_data</span><span class="w"> </span><span class="c1">//对输入图像进行预处理，调整合适的尺寸，获取一个输入指针。</span>

<span class="mf">5.</span><span class="n">创建一个输出buffer</span><span class="err">，</span><span class="n">实际已经预分配好了</span><span class="err">，</span><span class="n">output_data数组中存储的是指针</span><span class="err">。</span>
<span class="kt">int</span><span class="w"> </span><span class="n">output_cnt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">yolov5</span><span class="p">.</span><span class="n">get_output_cnt</span><span class="p">();</span>
<span class="kt">float</span><span class="w"> </span><span class="o">**</span><span class="n">output_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="p">[</span><span class="n">output_cnt</span><span class="p">]();</span>
<span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">output_cnt</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="w">    </span><span class="n">output_data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">float</span><span class="p">[</span><span class="n">yolov5</span><span class="p">.</span><span class="n">m_output_data_len</span><span class="p">[</span><span class="n">i</span><span class="p">]];</span>

<span class="c1">//模型跑多少次？loop_count</span>
<span class="k">while</span><span class="p">(</span><span class="n">count</span><span class="w"> </span><span class="o">&lt;</span><span class="n">loop_count</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">count</span><span class="w"> </span><span class="o">++</span><span class="p">;</span>
<span class="w">    </span><span class="mf">5.</span><span class="w"> </span><span class="n">配置网络的输入和输出缓存区</span>
<span class="w">    </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">yolov5</span><span class="p">.</span><span class="n">network_input_output_set</span><span class="p">()</span>
<span class="w">        </span><span class="n">vip_set_input</span>
<span class="w">        </span><span class="n">vip_set_output</span>
<span class="w">    </span><span class="mf">6.</span><span class="w"> </span><span class="n">提交运行网络的任务</span><span class="err">，</span><span class="n">开始运行网络</span>
<span class="w">    </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">yolov5</span><span class="p">.</span><span class="n">network_run</span><span class="p">();</span>
<span class="w">    </span><span class="mf">7.</span><span class="w"> </span><span class="n">获取输出</span><span class="err">，</span><span class="n">输出是什么样的格式</span><span class="err">？</span>
<span class="w">    </span><span class="n">yolov5</span><span class="p">.</span><span class="n">get_output</span><span class="p">(</span><span class="n">output_data</span><span class="p">);</span>
<span class="w">    </span><span class="mf">8.</span><span class="n">后处理</span>
<span class="w">    </span><span class="n">yolov5_postprocess</span><span class="p">(</span><span class="n">input_file</span><span class="p">,</span><span class="w"> </span><span class="n">output_data</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<h2 id="_2">模型输入预处理</h2>
<p>输入数据预处理</p>
<div class="codehilite"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">get_input_data</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">image_file</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">input_data</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">letterbox_rows</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">letterbox_cols</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">sample</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">imread</span><span class="p">(</span><span class="n">image_file</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sample</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="w"> </span><span class="s">"cv::imread %s failed</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="w"> </span><span class="n">image_file</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">img</span><span class="p">;</span>
<span class="w">    </span><span class="n">cv</span><span class="o">::</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">sample</span><span class="p">,</span><span class="w"> </span><span class="n">img</span><span class="p">,</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">COLOR_BGR2RGB</span><span class="p">);</span>

<span class="w">    </span><span class="cm">/* letterbox process to support different letterbox size */</span>

<span class="w">    </span><span class="c1">//按比例缩放输入图片</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">scale_letterbox</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">letterbox_rows</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1.0</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">img</span><span class="p">.</span><span class="n">rows</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="p">(</span><span class="n">letterbox_cols</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1.0</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">img</span><span class="p">.</span><span class="n">cols</span><span class="p">)){</span>
<span class="w">        </span><span class="n">scale_letterbox</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">letterbox_rows</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1.0</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">img</span><span class="p">.</span><span class="n">rows</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">scale_letterbox</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">letterbox_cols</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1.0</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">img</span><span class="p">.</span><span class="n">cols</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">resize_cols</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">int</span><span class="p">(</span><span class="n">scale_letterbox</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">img</span><span class="p">.</span><span class="n">cols</span><span class="p">);</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">resize_rows</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">int</span><span class="p">(</span><span class="n">scale_letterbox</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">img</span><span class="p">.</span><span class="n">rows</span><span class="p">);</span>
<span class="w">    </span><span class="n">cv</span><span class="o">::</span><span class="n">resize</span><span class="p">(</span><span class="n">img</span><span class="p">,</span><span class="w"> </span><span class="n">img</span><span class="p">,</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">Size</span><span class="p">(</span><span class="n">resize_cols</span><span class="p">,</span><span class="w"> </span><span class="n">resize_rows</span><span class="p">));</span>

<span class="w">    </span><span class="c1">// 创建Mat，但并不会进行内存拷贝而是创建了一个 头部指针（header）</span>
<span class="w">    </span><span class="c1">//来引用 input_data 指向的内存。</span>
<span class="w">    </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">img_new</span><span class="p">(</span><span class="n">letterbox_cols</span><span class="p">,</span><span class="w"> </span><span class="n">letterbox_rows</span><span class="p">,</span><span class="w"> </span><span class="n">CV_8UC3</span><span class="p">,</span><span class="w"> </span><span class="n">input_data</span><span class="p">);</span>

<span class="w">    </span><span class="c1">//保持原始图像长宽比的同时缩放到目标尺寸，不足部分用灰色(114)填充</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">top</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">letterbox_rows</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">resize_rows</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">bot</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">letterbox_rows</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">resize_rows</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">left</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">letterbox_cols</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">resize_cols</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">right</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">letterbox_cols</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">resize_cols</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// Letterbox filling</span>
<span class="w">    </span><span class="n">cv</span><span class="o">::</span><span class="n">copyMakeBorder</span><span class="p">(</span><span class="n">img</span><span class="p">,</span><span class="w"> </span><span class="n">img_new</span><span class="p">,</span><span class="w"> </span><span class="n">top</span><span class="p">,</span><span class="w"> </span><span class="n">bot</span><span class="p">,</span><span class="w"> </span><span class="n">left</span><span class="p">,</span><span class="w"> </span><span class="n">right</span><span class="p">,</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">BORDER_CONSTANT</span><span class="p">,</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">Scalar</span><span class="p">(</span><span class="mi">114</span><span class="p">,</span><span class="w"> </span><span class="mi">114</span><span class="p">,</span><span class="w"> </span><span class="mi">114</span><span class="p">));</span>
<span class="p">}</span>
</code></pre></div>
<h2 id="_3">模型后处理</h2>
<div class="codehilite"><pre><span></span><code><span class="kt">int</span><span class="w"> </span><span class="nf">yolov5_postprocess</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">imagepath</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="o">**</span><span class="n">output</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">imread</span><span class="p">(</span><span class="n">imagepath</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="n">objects</span><span class="p">;</span>
<span class="w">    </span><span class="n">detect_yolov5_rt</span><span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="n">objects</span><span class="p">,</span><span class="w"> </span><span class="n">output</span><span class="p">);</span>
<span class="w">    </span><span class="n">draw_objects</span><span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="n">objects</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">detect_yolov5_rt</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="o">&amp;</span><span class="w"> </span><span class="n">bgr</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;&amp;</span><span class="w"> </span><span class="n">objects</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="o">**</span><span class="n">output</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">steady_clock</span><span class="o">::</span><span class="n">time_point</span><span class="w"> </span><span class="n">Tbegin</span><span class="p">,</span><span class="w"> </span><span class="n">Tend</span><span class="p">;</span>

<span class="w">    </span><span class="mf">1.</span><span class="n">使用</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">steady_clock</span><span class="w"> </span><span class="n">进行时间计时</span><span class="err">，</span><span class="n">计算函数执行时间</span><span class="err">。</span>
<span class="w">        </span><span class="n">Tbegin</span><span class="w"> </span><span class="n">记录开始时间</span><span class="err">，</span><span class="n">Tend</span><span class="w"> </span><span class="n">用于记录结束时间</span><span class="err">。</span>
<span class="w">    </span><span class="n">Tbegin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">steady_clock</span><span class="o">::</span><span class="n">now</span><span class="p">();</span>

<span class="w">    </span><span class="mf">2.</span><span class="w"> </span><span class="n">output</span><span class="w"> </span><span class="n">是一个三维数组</span><span class="err">，</span><span class="n">通常包含3个特征图</span><span class="err">，</span><span class="n">每个特征图对应不同尺度的输出数据</span><span class="err">。</span>
<span class="w">        </span><span class="n">每个特征图中的数据会被逐步解析</span><span class="err">，</span><span class="n">以得到目标物体的位置和类别信息</span><span class="err">。</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w">  </span><span class="o">*</span><span class="n">p8_data_ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="n">p16_data_ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">output</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="n">p32_data_ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">output</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

<span class="w">    </span><span class="c1">// set default letterbox size</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">letterbox_rows</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LETTERBOX_ROWS</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">letterbox_cols</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LETTERBOX_COLS</span><span class="p">;</span>
<span class="w">    </span><span class="cm">/* postprocess */</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">prob_threshold</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SCORE_THRESHOLD</span><span class="p">;</span>
<span class="w">    </span><span class="c1">//物体的置信度阈值，低于该值的目标将被丢弃。</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">nms_threshold</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NMS_THRESHOLD</span><span class="p">;</span>
<span class="w">    </span><span class="c1">//用于非最大抑制的阈值，用于去除重复的检测框，保留具有最高置信度的框。</span>

<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="n">proposals</span><span class="p">;</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="n">objects8</span><span class="p">;</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="n">objects16</span><span class="p">;</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="n">objects32</span><span class="p">;</span>

<span class="w">    </span><span class="mf">3.</span><span class="n">generate_proposals_rt是一个用于从每个尺度的输出特征图中生成候选框</span><span class="err">（</span><span class="n">proposals</span><span class="err">）</span>
<span class="w">    </span><span class="n">函数</span><span class="err">。</span><span class="n">每个尺度</span><span class="err">（</span><span class="mi">8</span><span class="n">x8</span><span class="err">、</span><span class="mi">16</span><span class="n">x16</span><span class="w"> </span><span class="n">和</span><span class="w"> </span><span class="mi">32</span><span class="n">x32</span><span class="err">）</span><span class="n">都会调用该函数</span><span class="err">，</span><span class="n">并将检测到的物体存储在对应</span>
<span class="w">    </span><span class="n">的objects向量中</span><span class="err">。</span>
<span class="w">    </span><span class="n">generate_proposals_rt</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span><span class="w"> </span><span class="n">p32_data_ptr</span><span class="p">,</span><span class="w"> </span><span class="n">prob_threshold</span><span class="p">,</span><span class="w"> </span><span class="n">objects32</span><span class="p">,</span><span class="w"> </span><span class="n">letterbox_cols</span><span class="p">,</span><span class="w"> </span><span class="n">letterbox_rows</span><span class="p">);</span>
<span class="w">    </span><span class="n">proposals</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">proposals</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span><span class="w"> </span><span class="n">objects32</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="w"> </span><span class="n">objects32</span><span class="p">.</span><span class="n">end</span><span class="p">());</span>
<span class="w">    </span><span class="n">generate_proposals_rt</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span><span class="w"> </span><span class="n">p16_data_ptr</span><span class="p">,</span><span class="w"> </span><span class="n">prob_threshold</span><span class="p">,</span><span class="w"> </span><span class="n">objects16</span><span class="p">,</span><span class="w"> </span><span class="n">letterbox_cols</span><span class="p">,</span><span class="w"> </span><span class="n">letterbox_rows</span><span class="p">);</span>
<span class="w">    </span><span class="n">proposals</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">proposals</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span><span class="w"> </span><span class="n">objects16</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="w"> </span><span class="n">objects16</span><span class="p">.</span><span class="n">end</span><span class="p">());</span>
<span class="w">    </span><span class="n">generate_proposals_rt</span><span class="p">(</span><span class="w"> </span><span class="mi">8</span><span class="p">,</span><span class="w">  </span><span class="n">p8_data_ptr</span><span class="p">,</span><span class="w"> </span><span class="n">prob_threshold</span><span class="p">,</span><span class="w"> </span><span class="n">objects8</span><span class="p">,</span><span class="w"> </span><span class="n">letterbox_cols</span><span class="p">,</span><span class="w"> </span><span class="n">letterbox_rows</span><span class="p">);</span>
<span class="w">    </span><span class="n">proposals</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">proposals</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span><span class="w"> </span><span class="n">objects8</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="w"> </span><span class="n">objects8</span><span class="p">.</span><span class="n">end</span><span class="p">());</span>

<span class="w">    </span><span class="mf">4.</span><span class="n">将候选框按照置信度排序</span><span class="err">，</span><span class="n">从高到低</span><span class="err">。</span>
<span class="w">    </span><span class="n">qsort_descent_inplace</span><span class="p">(</span><span class="n">proposals</span><span class="p">);</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="w"> </span><span class="n">picked</span><span class="p">;</span>
<span class="w">    </span><span class="mf">5.</span><span class="n">进行非最大抑制</span><span class="err">，</span><span class="n">去除冗余的候选框</span><span class="err">，</span><span class="n">保留置信度较高且没有重叠过多的框</span><span class="err">。</span>
<span class="w">      </span><span class="n">picked</span><span class="w"> </span><span class="n">向量存储最终选择的框的索引</span><span class="err">。</span>
<span class="w">    </span><span class="n">nms_sorted_bboxes</span><span class="p">(</span><span class="n">proposals</span><span class="p">,</span><span class="w"> </span><span class="n">picked</span><span class="p">,</span><span class="w"> </span><span class="n">nms_threshold</span><span class="p">);</span>

<span class="w">    </span><span class="mf">6.</span><span class="w"> </span><span class="n">调整框的位置</span><span class="err">（</span><span class="n">从</span><span class="w"> </span><span class="n">letterbox</span><span class="w"> </span><span class="n">大小到原始图像大小</span><span class="err">）</span>
<span class="w">    </span><span class="n">计算输入图像与</span><span class="w"> </span><span class="n">letterbox</span><span class="w"> </span><span class="n">大小之间的缩放比率</span><span class="err">。</span><span class="n">letterbox</span><span class="w"> </span><span class="n">是指图像填充到</span>
<span class="w">    </span><span class="n">固定尺寸时</span><span class="err">，</span><span class="n">保持原图宽高比的矩形区域</span><span class="err">。</span><span class="n">计算缩放后的图像尺寸</span><span class="err">，</span><span class="n">并根据缩放比例</span>
<span class="w">    </span><span class="n">调整框的位置</span><span class="err">。</span>
<span class="w">    </span><span class="cm">/* yolov5 draw the result */</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">scale_letterbox</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">resize_rows</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">resize_cols</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">letterbox_rows</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1.0</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">bgr</span><span class="p">.</span><span class="n">rows</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="p">(</span><span class="n">letterbox_cols</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1.0</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">bgr</span><span class="p">.</span><span class="n">cols</span><span class="p">))</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">scale_letterbox</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">letterbox_rows</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1.0</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">bgr</span><span class="p">.</span><span class="n">rows</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">scale_letterbox</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">letterbox_cols</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1.0</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">bgr</span><span class="p">.</span><span class="n">cols</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">resize_cols</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">int</span><span class="p">(</span><span class="n">scale_letterbox</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">bgr</span><span class="p">.</span><span class="n">cols</span><span class="p">);</span>
<span class="w">    </span><span class="n">resize_rows</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">int</span><span class="p">(</span><span class="n">scale_letterbox</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">bgr</span><span class="p">.</span><span class="n">rows</span><span class="p">);</span>

<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">tmp_h</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">letterbox_rows</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">resize_rows</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">tmp_w</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">letterbox_cols</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">resize_cols</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>

<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">ratio_x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="n">bgr</span><span class="p">.</span><span class="n">rows</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">resize_rows</span><span class="p">;</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">ratio_y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="n">bgr</span><span class="p">.</span><span class="n">cols</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">resize_cols</span><span class="p">;</span>

<span class="w">    </span><span class="mf">7.</span><span class="w"> </span><span class="n">修正目标框的位置</span><span class="p">.</span><span class="n">picked</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="n">表示最终选中的目标框数量</span><span class="err">。</span><span class="n">对于每个选</span>
<span class="w">    </span><span class="n">中的目标框</span><span class="err">（</span><span class="n">通过</span><span class="w"> </span><span class="n">picked</span><span class="w"> </span><span class="n">向量索引</span><span class="err">），</span><span class="n">调整其坐标</span><span class="err">，</span><span class="n">从</span><span class="w"> </span><span class="n">letterbox</span><span class="w"> </span><span class="n">坐标系转换回</span>
<span class="w">    </span><span class="n">原图坐标系</span><span class="err">。</span><span class="n">通过计算得到的</span><span class="w"> </span><span class="n">ratio_x</span><span class="w"> </span><span class="n">和</span><span class="w"> </span><span class="n">ratio_y</span><span class="w"> </span><span class="n">来调整坐标</span><span class="err">，</span><span class="n">确保目标框与原始</span>
<span class="w">    </span><span class="n">图像大小一致</span><span class="err">。</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">picked</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
<span class="w">    </span><span class="n">objects</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">count</span><span class="p">);</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">count</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">objects</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">proposals</span><span class="p">[</span><span class="n">picked</span><span class="p">[</span><span class="n">i</span><span class="p">]];</span>
<span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">x0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">objects</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rect</span><span class="p">.</span><span class="n">x</span><span class="p">);</span>
<span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">y0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">objects</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rect</span><span class="p">.</span><span class="n">y</span><span class="p">);</span>
<span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">x1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">objects</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rect</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">objects</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rect</span><span class="p">.</span><span class="n">width</span><span class="p">);</span>
<span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">y1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">objects</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rect</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">objects</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rect</span><span class="p">.</span><span class="n">height</span><span class="p">);</span>

<span class="w">        </span><span class="n">x0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">x0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">tmp_w</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">ratio_x</span><span class="p">;</span>
<span class="w">        </span><span class="n">y0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">y0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">tmp_h</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">ratio_y</span><span class="p">;</span>
<span class="w">        </span><span class="n">x1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">x1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">tmp_w</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">ratio_x</span><span class="p">;</span>
<span class="w">        </span><span class="n">y1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">y1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">tmp_h</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">ratio_y</span><span class="p">;</span>

<span class="w">        </span><span class="n">x0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">max</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">min</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">float</span><span class="p">)(</span><span class="n">bgr</span><span class="p">.</span><span class="n">cols</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)),</span><span class="w"> </span><span class="mf">0.f</span><span class="p">);</span>
<span class="w">        </span><span class="n">y0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">max</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">min</span><span class="p">(</span><span class="n">y0</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">float</span><span class="p">)(</span><span class="n">bgr</span><span class="p">.</span><span class="n">rows</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)),</span><span class="w"> </span><span class="mf">0.f</span><span class="p">);</span>
<span class="w">        </span><span class="n">x1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">max</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">min</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">float</span><span class="p">)(</span><span class="n">bgr</span><span class="p">.</span><span class="n">cols</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)),</span><span class="w"> </span><span class="mf">0.f</span><span class="p">);</span>
<span class="w">        </span><span class="n">y1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">max</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">min</span><span class="p">(</span><span class="n">y1</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">float</span><span class="p">)(</span><span class="n">bgr</span><span class="p">.</span><span class="n">rows</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)),</span><span class="w"> </span><span class="mf">0.f</span><span class="p">);</span>

<span class="w">        </span><span class="n">objects</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rect</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x0</span><span class="p">;</span>
<span class="w">        </span><span class="n">objects</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rect</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">y0</span><span class="p">;</span>
<span class="w">        </span><span class="n">objects</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rect</span><span class="p">.</span><span class="n">width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">x0</span><span class="p">;</span>
<span class="w">        </span><span class="n">objects</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rect</span><span class="p">.</span><span class="n">height</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">y1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">y0</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="mf">8.</span><span class="w"> </span><span class="n">计算函数执行时间</span><span class="err">，</span><span class="n">并输出检测到的目标数目</span>
<span class="w">    </span><span class="n">Tend</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">steady_clock</span><span class="o">::</span><span class="n">now</span><span class="p">();</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">duration_cast</span><span class="w"> </span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">milliseconds</span><span class="o">&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">Tend</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Tbegin</span><span class="p">).</span><span class="n">count</span><span class="p">();</span>
<span class="w">    </span><span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="w"> </span><span class="s">"detection num: %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="w"> </span><span class="n">count</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>该函数主要用于处理 YOLOv5 模型的输出结果，通过三个不同尺度的输出特征图来生成候选框，然后使用非最大抑制（NMS）去除冗余框，最后将目标框的坐标从 letterbox 坐标系转换回原始图像的坐标系。该函数的核心任务是目标检测的后处理，包括筛选高置信度框、去除重复框、调整框位置等步骤。</p>
<h3 id="_4">计算先验框矩形坐标</h3>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">generate_proposals_rt</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">stride</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">feat</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">prob_threshold</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;&amp;</span><span class="w"> </span><span class="n">objects</span><span class="p">,</span>
<span class="w">                               </span><span class="kt">int</span><span class="w"> </span><span class="n">letterbox_cols</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">letterbox_rows</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">anchors</span><span class="p">[</span><span class="mi">18</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">13</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="p">,</span><span class="w"> </span><span class="mi">30</span><span class="p">,</span><span class="w"> </span><span class="mi">33</span><span class="p">,</span><span class="w"> </span><span class="mi">23</span><span class="p">,</span><span class="w"> </span><span class="mi">30</span><span class="p">,</span><span class="w"> </span><span class="mi">61</span><span class="p">,</span><span class="w"> </span><span class="mi">62</span><span class="p">,</span><span class="w"> </span><span class="mi">45</span><span class="p">,</span><span class="w"> </span><span class="mi">59</span><span class="p">,</span><span class="w"> </span><span class="mi">119</span><span class="p">,</span><span class="w"> </span><span class="mi">116</span><span class="p">,</span><span class="w"> </span><span class="mi">90</span><span class="p">,</span><span class="w"> </span><span class="mi">156</span><span class="p">,</span><span class="w"> </span><span class="mi">198</span><span class="p">,</span><span class="w"> </span><span class="mi">373</span><span class="p">,</span><span class="w"> </span><span class="mi">326</span><span class="p">};</span>
<span class="w">    </span><span class="c1">//YOLO预定义的anchor尺寸，共9组(每组宽高)，18个值</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">anchor_num</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span><span class="w"> </span><span class="c1">//3个先验框</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">feat_w</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">letterbox_cols</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">stride</span><span class="p">;</span><span class="w"> </span><span class="c1">//计算特征图大小，如果是下采样8倍</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">feat_h</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">letterbox_rows</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">stride</span><span class="p">;</span><span class="w"> </span><span class="c1">//那就是80 * 80</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">cls_num</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CLASS_NUM</span><span class="p">;</span><span class="w"> </span><span class="c1">//分类数量，默认是80</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">anchor_group</span><span class="p">;</span><span class="w"> </span><span class="c1">//对先验框进行分组</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">stride</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">8</span><span class="p">)</span>
<span class="w">        </span><span class="n">anchor_group</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">stride</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">16</span><span class="p">)</span>
<span class="w">        </span><span class="n">anchor_group</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">stride</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">32</span><span class="p">)</span>
<span class="w">        </span><span class="n">anchor_group</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span>
<span class="w">    </span><span class="c1">//反Sigmoid函数,将0~1的输入转化为原始值</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">deprob_threshold</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">desigmoid</span><span class="p">(</span><span class="n">prob_threshold</span><span class="p">);</span>
<span class="w">    </span><span class="c1">//特征图的尺寸大小，如果是8倍下采样就是80*80=6400份</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">feat_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">feat_w</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">feat_h</span><span class="p">;</span>
<span class="w">    </span><span class="c1">//计算单个anchor的特征数据总量，用于定位内存中不同anchor的偏移位置</span>
<span class="w">    </span><span class="c1">//通过feat_ptr + feat_size_cls_5 * n可精确访问第n个anchor的预测数据</span>
<span class="w">    </span><span class="c1">//feat_size_cls_5 = 80*80*85 = 544000</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">feat_size_cls_5</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">feat_size</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">cls_num</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">5</span><span class="p">);</span>
<span class="w">    </span><span class="c1">//YOLOv5的输出特征图按(cls_num+5)*anchor_num*feat_size组织</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="n">feat_ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">float</span><span class="o">*</span><span class="p">)</span><span class="n">feat</span><span class="p">;</span>

<span class="w">    </span><span class="c1">//将原始一维特征数组feat_ptr转换为3个二维矩阵anchor_0/1/2，每个矩阵维度为(cls_num+5)×feat_size</span>
<span class="w">    </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">anchor_0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="p">((</span><span class="n">cls_num</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">5</span><span class="p">),</span><span class="w"> </span><span class="n">feat_size</span><span class="p">,</span><span class="w"> </span><span class="n">CV_32FC1</span><span class="p">,</span><span class="w"> </span><span class="n">feat_ptr</span><span class="p">);</span>
<span class="w">    </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">anchor_1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="p">((</span><span class="n">cls_num</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">5</span><span class="p">),</span><span class="w"> </span><span class="n">feat_size</span><span class="p">,</span><span class="w"> </span><span class="n">CV_32FC1</span><span class="p">,</span><span class="w"> </span><span class="n">feat_ptr</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">feat_size_cls_5</span><span class="p">);</span>
<span class="w">    </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">anchor_2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="p">((</span><span class="n">cls_num</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">5</span><span class="p">),</span><span class="w"> </span><span class="n">feat_size</span><span class="p">,</span><span class="w"> </span><span class="n">CV_32FC1</span><span class="p">,</span><span class="w"> </span><span class="n">feat_ptr</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">feat_size_cls_5</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span>

<span class="w">     </span><span class="c1">//anchor_0直接引用feat_ptr起始地址，对应第一个anchor的预测数据。</span>
<span class="w">     </span><span class="c1">//anchor_1通过feat_ptr + feat_size_cls_5偏移，定位到第二个anchor的数据块。</span>
<span class="w">     </span><span class="c1">//anchor_2使用feat_size_cls_5*2偏移量访问第三个anchor数据。</span>
<span class="w">    </span><span class="n">cv</span><span class="o">::</span><span class="n">transpose</span><span class="p">(</span><span class="n">anchor_0</span><span class="p">,</span><span class="w"> </span><span class="n">anchor_0</span><span class="p">);</span>
<span class="w">    </span><span class="n">cv</span><span class="o">::</span><span class="n">transpose</span><span class="p">(</span><span class="n">anchor_1</span><span class="p">,</span><span class="w"> </span><span class="n">anchor_1</span><span class="p">);</span>
<span class="w">    </span><span class="n">cv</span><span class="o">::</span><span class="n">transpose</span><span class="p">(</span><span class="n">anchor_2</span><span class="p">,</span><span class="w"> </span><span class="n">anchor_2</span><span class="p">);</span>

<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="n">anchor_data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{(</span><span class="kt">float</span><span class="o">*</span><span class="p">)</span><span class="n">anchor_0</span><span class="p">.</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">float</span><span class="o">*</span><span class="p">)</span><span class="n">anchor_1</span><span class="p">.</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">float</span><span class="o">*</span><span class="p">)</span><span class="n">anchor_2</span><span class="p">.</span><span class="n">data</span><span class="p">};</span>
<span class="w">    </span><span class="c1">//创建float*类型的数组anchor_data[3]，存储3个锚点矩阵的数据指针。</span>

<span class="w">    </span><span class="c1">//三重循环分别遍历特征图高度(feat_h)、宽度(feat_w)和锚点数量(anchor_num)</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">h</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">h</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">feat_h</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">h</span><span class="o">++</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">h_feat_w_cls_5</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">h</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">feat_w</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">cls_num</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">5</span><span class="p">);</span>
<span class="w">        </span><span class="c1">//h_feat_w_cls_5计算当前行在特征图中的内存偏移量，</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">w</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">w</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">feat_w</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">w</span><span class="o">++</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">w_cls_5</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="n">w</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">cls_num</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">5</span><span class="p">);</span>
<span class="w">            </span><span class="c1">//w_cls_5计算当前列在行内的偏移量</span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">anchor_num</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">a</span><span class="o">++</span><span class="p">)</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">                </span><span class="c1">//process cls score</span>
<span class="w">                </span><span class="kt">int</span><span class="w"> </span><span class="n">class_index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">                </span><span class="kt">float</span><span class="w"> </span><span class="n">class_score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">FLT_MAX</span><span class="p">;</span>
<span class="w">                </span><span class="kt">int</span><span class="w"> </span><span class="n">a_idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">h_feat_w_cls_5</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">w_cls_5</span><span class="p">;</span>
<span class="w">                </span><span class="c1">//定位到当前锚点的类别分数起始位置（+4跳过前4个坐标参数）</span>
<span class="w">                </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="n">feat_ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">anchor_data</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">a_idx</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span>
<span class="w">                </span><span class="c1">//遍历所有类别(cls_num)，通过比较*(feat_ptr + s + 1)获</span>
<span class="w">                </span><span class="c1">//遍历类别概率索引，计算类别中概率最高得分，用于计算先验框分数</span>
<span class="w">                </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">cls_num</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">s</span><span class="o">++</span><span class="p">)</span>
<span class="w">                </span><span class="p">{</span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="cm">/*score*/</span><span class="w"> </span><span class="o">*</span><span class="p">(</span><span class="n">feat_ptr</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">class_score</span><span class="p">)</span>
<span class="w">                    </span><span class="p">{</span>
<span class="w">                        </span><span class="n">class_index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s</span><span class="p">;</span>
<span class="w">                        </span><span class="n">class_score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="p">(</span><span class="n">feat_ptr</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w">  </span><span class="c1">//score;</span>
<span class="w">                    </span><span class="p">}</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">                </span><span class="c1">//process box score</span>
<span class="w">                </span><span class="kt">float</span><span class="w"> </span><span class="n">box_score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">feat_ptr</span><span class="p">;</span>
<span class="w">                </span><span class="c1">//box_score直接读取特征图数据（*feat_ptr），表示当前锚点包含目标的置信度</span>

<span class="w">                </span><span class="kt">float</span><span class="w"> </span><span class="n">final_score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">;</span>
<span class="w">                </span><span class="c1">//采用双阈值过滤机制（deprob_threshold），仅当框分数和类别分数均达标时才计算最终分数</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">box_score</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">deprob_threshold</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">class_score</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">deprob_threshold</span><span class="p">)</span>
<span class="w">                    </span><span class="n">final_score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sigmoid</span><span class="p">(</span><span class="n">box_score</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">sigmoid</span><span class="p">(</span><span class="n">class_score</span><span class="p">);</span>
<span class="w">                    </span><span class="c1">//先验框得分 = 置信度值 x 类别概率中最大的值</span>
<span class="w">                </span><span class="c1">//下面是YOLOv5特有的解码格式计算矩形框(x0,y0,x1,y1)</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">final_score</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">prob_threshold</span><span class="p">)</span>
<span class="w">                </span><span class="p">{</span>
<span class="w">                    </span><span class="kt">int</span><span class="w"> </span><span class="n">loc_idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a_idx</span><span class="p">;</span>
<span class="w">                    </span><span class="kt">float</span><span class="w"> </span><span class="n">dx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sigmoid</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">anchor_data</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">loc_idx</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">0</span><span class="p">));</span>
<span class="w">                    </span><span class="kt">float</span><span class="w"> </span><span class="n">dy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sigmoid</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">anchor_data</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">loc_idx</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">));</span>
<span class="w">                    </span><span class="kt">float</span><span class="w"> </span><span class="n">dw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sigmoid</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">anchor_data</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">loc_idx</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="p">));</span>
<span class="w">                    </span><span class="kt">float</span><span class="w"> </span><span class="n">dh</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sigmoid</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">anchor_data</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">loc_idx</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">3</span><span class="p">));</span>
<span class="w">                    </span><span class="kt">float</span><span class="w"> </span><span class="n">pred_cx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">dx</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">2.0f</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">0.5f</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">w</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">stride</span><span class="p">;</span>
<span class="w">                    </span><span class="kt">float</span><span class="w"> </span><span class="n">pred_cy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">dy</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">2.0f</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">0.5f</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">h</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">stride</span><span class="p">;</span>
<span class="w">                    </span><span class="kt">float</span><span class="w"> </span><span class="n">anchor_w</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">anchors</span><span class="p">[(</span><span class="n">anchor_group</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">0</span><span class="p">];</span>
<span class="w">                    </span><span class="kt">float</span><span class="w"> </span><span class="n">anchor_h</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">anchors</span><span class="p">[(</span><span class="n">anchor_group</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">];</span>
<span class="w">                    </span><span class="kt">float</span><span class="w"> </span><span class="n">pred_w</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dw</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">dw</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">4.0f</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">anchor_w</span><span class="p">;</span>
<span class="w">                    </span><span class="kt">float</span><span class="w"> </span><span class="n">pred_h</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dh</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">dh</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">4.0f</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">anchor_h</span><span class="p">;</span>
<span class="w">                    </span><span class="kt">float</span><span class="w"> </span><span class="n">x0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pred_cx</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">pred_w</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">0.5f</span><span class="p">;</span>
<span class="w">                    </span><span class="kt">float</span><span class="w"> </span><span class="n">y0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pred_cy</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">pred_h</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">0.5f</span><span class="p">;</span>
<span class="w">                    </span><span class="kt">float</span><span class="w"> </span><span class="n">x1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pred_cx</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">pred_w</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">0.5f</span><span class="p">;</span>
<span class="w">                    </span><span class="kt">float</span><span class="w"> </span><span class="n">y1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pred_cy</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">pred_h</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">0.5f</span><span class="p">;</span>

<span class="w">                    </span><span class="n">Object</span><span class="w"> </span><span class="n">obj</span><span class="p">;</span>
<span class="w">                    </span><span class="n">obj</span><span class="p">.</span><span class="n">rect</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x0</span><span class="p">;</span>
<span class="w">                    </span><span class="n">obj</span><span class="p">.</span><span class="n">rect</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">y0</span><span class="p">;</span>
<span class="w">                    </span><span class="n">obj</span><span class="p">.</span><span class="n">rect</span><span class="p">.</span><span class="n">width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">x0</span><span class="p">;</span>
<span class="w">                    </span><span class="n">obj</span><span class="p">.</span><span class="n">rect</span><span class="p">.</span><span class="n">height</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">y1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">y0</span><span class="p">;</span>
<span class="w">                    </span><span class="n">obj</span><span class="p">.</span><span class="n">label</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">class_index</span><span class="p">;</span>
<span class="w">                    </span><span class="c1">//先验框最后得分 = 置信度值 x 类别概率中最大的值</span>
<span class="w">                    </span><span class="n">obj</span><span class="p">.</span><span class="n">prob</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">final_score</span><span class="p">;</span>
<span class="w">                    </span><span class="c1">//预测框被封装为Object结构体，存入objects向量供后续NMS处理</span>
<span class="w">                    </span><span class="n">objects</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>generate_proposals_rt函数的作用是把所有先验框的信息（坐标信息、置信度、分类概率）计算处理放到objects中。一共是25200个先验框数量。</p>
<ul>
<li>8倍下采样先验框数量： 3 x 80 x 80 = 19200</li>
<li>16倍下采样先验框数量： 3 x 40 x 40 = 4800</li>
<li>32倍下采样先验框数量： 3 x 20 x 20 = 1200</li>
</ul>
<h3 id="_5">非极大值抑制</h3>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">qsort_descent_inplace</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;&amp;</span><span class="w"> </span><span class="n">objects</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">left</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">right</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">left</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">right</span><span class="p">;</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">objects</span><span class="p">[(</span><span class="n">left</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">right</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="p">].</span><span class="n">prob</span><span class="p">;</span>

<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">j</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">objects</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">prob</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">p</span><span class="p">)</span>
<span class="w">            </span><span class="n">i</span><span class="o">++</span><span class="p">;</span>

<span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">objects</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">prob</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">p</span><span class="p">)</span>
<span class="w">            </span><span class="n">j</span><span class="o">--</span><span class="p">;</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">j</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// swap</span>
<span class="w">            </span><span class="n">std</span><span class="o">::</span><span class="n">swap</span><span class="p">(</span><span class="n">objects</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="w"> </span><span class="n">objects</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>

<span class="w">            </span><span class="n">i</span><span class="o">++</span><span class="p">;</span>
<span class="w">            </span><span class="n">j</span><span class="o">--</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="cp">#pragma omp parallel sections</span>
<span class="w">    </span><span class="p">{</span>
<span class="cp">#pragma omp section</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">left</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="n">qsort_descent_inplace</span><span class="p">(</span><span class="n">objects</span><span class="p">,</span><span class="w"> </span><span class="n">left</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="cp">#pragma omp section</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">right</span><span class="p">)</span><span class="w"> </span><span class="n">qsort_descent_inplace</span><span class="p">(</span><span class="n">objects</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">right</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">qsort_descent_inplace</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;&amp;</span><span class="w"> </span><span class="n">objects</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">objects</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span>

<span class="w">    </span><span class="n">qsort_descent_inplace</span><span class="p">(</span><span class="n">objects</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">objects</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>按照先验框得分使用快排进行排序，先验框得分为先验框得分 = 置信度值 x 类别概率中最大的值，在generate_proposals中计算而来。</p>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">nms_sorted_bboxes</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;&amp;</span><span class="w"> </span><span class="n">objects</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;&amp;</span><span class="w"> </span><span class="n">picked</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">nms_threshold</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">agnostic</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">//清空输出容器picked, 预计算所有检测框面积存入areas数组，避免重复计算。</span>
<span class="w">    </span><span class="n">picked</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">objects</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="w"> </span><span class="n">areas</span><span class="p">(</span><span class="n">n</span><span class="p">);</span>
<span class="w">    </span><span class="c1">//调用OpenCV的area()方法计算每个矩形框面积</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">areas</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">objects</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rect</span><span class="p">.</span><span class="n">area</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">//遍历所有检测框，初始化当前框的保留标志keep</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="n">Object</span><span class="o">&amp;</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">objects</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">keep</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">        </span><span class="c1">//循环遍历已选中的检测框进行IoU计算</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">picked</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="w"> </span><span class="n">j</span><span class="o">++</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="k">const</span><span class="w"> </span><span class="n">Object</span><span class="o">&amp;</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">objects</span><span class="p">[</span><span class="n">picked</span><span class="p">[</span><span class="n">j</span><span class="p">]];</span>
<span class="w">            </span><span class="c1">// intersection over union</span>
<span class="w">            </span><span class="kt">float</span><span class="w"> </span><span class="n">inter_area</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">intersection_area</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">);</span>
<span class="w">            </span><span class="kt">float</span><span class="w"> </span><span class="n">union_area</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">areas</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">areas</span><span class="p">[</span><span class="n">picked</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">inter_area</span><span class="p">;</span>
<span class="w">            </span><span class="c1">//计算交并比：inter_area / union_area,超过阈值则标记当前框为抑制状态</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">inter_area</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">union_area</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">nms_threshold</span><span class="p">)</span>
<span class="w">                </span><span class="n">keep</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="c1">//未被抑制的框索引加入结果集</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">keep</span><span class="p">)</span>
<span class="w">            </span><span class="n">picked</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="_6">绘制目标框</h3>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">draw_objects</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="o">&amp;</span><span class="w"> </span><span class="n">bgr</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;&amp;</span><span class="w"> </span><span class="n">objects</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">steady_clock</span><span class="o">::</span><span class="n">time_point</span><span class="w"> </span><span class="n">Tbegin</span><span class="p">,</span><span class="w"> </span><span class="n">Tend</span><span class="p">;</span>
<span class="w">    </span><span class="mf">1.</span><span class="n">使用</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">steady_clock</span><span class="w"> </span><span class="n">进行时间计时</span><span class="err">。</span><span class="n">Tbegin</span><span class="w"> </span><span class="n">记录开始时间</span><span class="err">，</span><span class="n">Tend</span>
<span class="w">        </span><span class="n">用于记录结束时间</span><span class="err">。</span><span class="n">目的是计算绘制物体框和标签的时间开销</span><span class="err">。</span>
<span class="w">    </span><span class="n">Tbegin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">steady_clock</span><span class="o">::</span><span class="n">now</span><span class="p">();</span>

<span class="w">    </span><span class="mf">2.</span><span class="n">将传入的原始图像</span><span class="w"> </span><span class="n">bgr</span><span class="w"> </span><span class="n">克隆到</span><span class="w"> </span><span class="n">image</span><span class="w"> </span><span class="n">中</span><span class="err">。</span><span class="n">这是因为原始图像不应该被修改</span><span class="err">，</span><span class="n">绘制操</span>
<span class="w">        </span><span class="n">作会在image上进行</span><span class="err">，</span><span class="n">而原图bgr保持不变</span><span class="err">。</span>
<span class="w">    </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">image</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bgr</span><span class="p">.</span><span class="n">clone</span><span class="p">();</span>

<span class="w">    </span><span class="mf">3.</span><span class="n">遍历</span><span class="w"> </span><span class="n">objects</span><span class="w"> </span><span class="n">向量</span><span class="err">，</span><span class="n">这个向量包含了所有检测到的物体</span><span class="err">（</span><span class="n">每个物体通过</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="n">类</span>
<span class="w">        </span><span class="n">型表示</span><span class="err">）。</span><span class="n">obj</span><span class="w"> </span><span class="n">是当前遍历到的物体</span><span class="err">。</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">objects</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="n">Object</span><span class="o">&amp;</span><span class="w"> </span><span class="n">obj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">objects</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

<span class="w">        </span><span class="mf">4.</span><span class="n">打印输出物体的详细信息</span><span class="err">：</span><span class="n">物体的标签</span><span class="w"> </span><span class="p">(</span><span class="n">obj</span><span class="p">.</span><span class="n">label</span><span class="p">)</span><span class="err">、</span><span class="n">置信度</span>
<span class="w">            </span><span class="p">(</span><span class="n">obj</span><span class="p">.</span><span class="n">prob</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span><span class="p">)</span><span class="err">、</span><span class="n">物体框的坐标</span><span class="err">（</span><span class="n">左上角和右下角</span><span class="err">），</span><span class="n">以及物体的类别</span>
<span class="w">            </span><span class="n">名称</span><span class="err">（</span><span class="n">g_classes_name</span><span class="p">[</span><span class="n">obj</span><span class="p">.</span><span class="n">label</span><span class="p">]</span><span class="err">）。</span><span class="n">这对于调试非常有用</span><span class="err">。</span>
<span class="w">        </span><span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="w"> </span><span class="s">"%2d: %3.0f%%, [%4.0f, %4.0f, %4.0f, %4.0f], %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="w"> </span><span class="n">obj</span><span class="p">.</span><span class="n">label</span><span class="p">,</span><span class="w"> </span><span class="n">obj</span><span class="p">.</span><span class="n">prob</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span><span class="w"> </span><span class="n">obj</span><span class="p">.</span><span class="n">rect</span><span class="p">.</span><span class="n">x</span><span class="p">,</span>
<span class="w">                </span><span class="n">obj</span><span class="p">.</span><span class="n">rect</span><span class="p">.</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">obj</span><span class="p">.</span><span class="n">rect</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">obj</span><span class="p">.</span><span class="n">rect</span><span class="p">.</span><span class="n">width</span><span class="p">,</span><span class="w"> </span><span class="n">obj</span><span class="p">.</span><span class="n">rect</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">obj</span><span class="p">.</span><span class="n">rect</span><span class="p">.</span><span class="n">height</span><span class="p">,</span><span class="w"> </span><span class="n">g_classes_name</span><span class="p">[</span><span class="n">obj</span><span class="p">.</span><span class="n">label</span><span class="p">].</span><span class="n">c_str</span><span class="p">());</span>

<span class="w">        </span><span class="mf">5.</span><span class="n">使用</span><span class="w"> </span><span class="n">OpenCV</span><span class="w"> </span><span class="n">的</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">rectangle</span><span class="w"> </span><span class="n">函数在图像上绘制矩形框</span><span class="err">，</span><span class="n">表示检测到的物体位置</span><span class="err">。</span>
<span class="w">        </span><span class="n">obj</span><span class="p">.</span><span class="n">rect</span><span class="w"> </span><span class="n">是物体的边界框</span><span class="err">，</span><span class="n">cv</span><span class="o">::</span><span class="n">Scalar</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="n">表示框的颜色为蓝色</span><span class="err">（</span><span class="n">BGR格式</span><span class="err">）。</span>
<span class="w">        </span><span class="n">cv</span><span class="o">::</span><span class="n">rectangle</span><span class="p">(</span><span class="n">image</span><span class="p">,</span><span class="w"> </span><span class="n">obj</span><span class="p">.</span><span class="n">rect</span><span class="p">,</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">Scalar</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">));</span>

<span class="w">        </span><span class="mf">6.</span><span class="w"> </span><span class="n">使用</span><span class="w"> </span><span class="n">sprintf</span><span class="w"> </span><span class="n">函数构造文本</span><span class="err">，</span><span class="n">显示物体的类别名称和置信度</span><span class="err">（</span><span class="n">格式为</span><span class="err">：</span><span class="n">类别名称</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">置信度百分比</span><span class="err">）。</span>
<span class="w">        </span><span class="n">g_classes_name</span><span class="p">[</span><span class="n">obj</span><span class="p">.</span><span class="n">label</span><span class="p">]</span><span class="w"> </span><span class="n">获取物体的类别名称</span><span class="err">，</span><span class="n">obj</span><span class="p">.</span><span class="n">prob</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span><span class="w"> </span><span class="n">表示物体的置信度</span><span class="err">。</span>
<span class="w">        </span><span class="kt">char</span><span class="w"> </span><span class="n">text</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
<span class="w">        </span><span class="n">sprintf</span><span class="p">(</span><span class="n">text</span><span class="p">,</span><span class="w"> </span><span class="s">"%s %.1f%%"</span><span class="p">,</span><span class="w"> </span><span class="n">g_classes_name</span><span class="p">[</span><span class="n">obj</span><span class="p">.</span><span class="n">label</span><span class="p">].</span><span class="n">c_str</span><span class="p">(),</span><span class="w"> </span><span class="n">obj</span><span class="p">.</span><span class="n">prob</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span><span class="p">);</span>

<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">baseLine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="n">cv</span><span class="o">::</span><span class="n">Size</span><span class="w"> </span><span class="n">label_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">getTextSize</span><span class="p">(</span><span class="n">text</span><span class="p">,</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">FONT_HERSHEY_SIMPLEX</span><span class="p">,</span><span class="w"> </span><span class="mf">0.5</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">baseLine</span><span class="p">);</span>

<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">obj</span><span class="p">.</span><span class="n">rect</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">obj</span><span class="p">.</span><span class="n">rect</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">label_size</span><span class="p">.</span><span class="n">height</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">baseLine</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">y</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">            </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">label_size</span><span class="p">.</span><span class="n">width</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">image</span><span class="p">.</span><span class="n">cols</span><span class="p">)</span>
<span class="w">            </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">image</span><span class="p">.</span><span class="n">cols</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">label_size</span><span class="p">.</span><span class="n">width</span><span class="p">;</span>
<span class="w">        </span><span class="c1">//绘制文本的白色背景矩形框</span>
<span class="w">        </span><span class="n">cv</span><span class="o">::</span><span class="n">rectangle</span><span class="p">(</span><span class="n">image</span><span class="p">,</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">Rect</span><span class="p">(</span><span class="n">cv</span><span class="o">::</span><span class="n">Point</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">),</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">Size</span><span class="p">(</span><span class="n">label_size</span><span class="p">.</span><span class="n">width</span><span class="p">,</span><span class="w"> </span><span class="n">label_size</span><span class="p">.</span><span class="n">height</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">baseLine</span><span class="p">)),</span>
<span class="w">                      </span><span class="n">cv</span><span class="o">::</span><span class="n">Scalar</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span><span class="w"> </span><span class="mi">255</span><span class="p">,</span><span class="w"> </span><span class="mi">255</span><span class="p">),</span><span class="w"> </span><span class="mi">-1</span><span class="p">);</span>
<span class="w">        </span><span class="c1">//绘制文本信息</span>
<span class="w">        </span><span class="n">cv</span><span class="o">::</span><span class="n">putText</span><span class="p">(</span><span class="n">image</span><span class="p">,</span><span class="w"> </span><span class="n">text</span><span class="p">,</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">Point</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">label_size</span><span class="p">.</span><span class="n">height</span><span class="p">),</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">FONT_HERSHEY_SIMPLEX</span><span class="p">,</span><span class="w"> </span><span class="mf">0.5</span><span class="p">,</span>
<span class="w">                    </span><span class="n">cv</span><span class="o">::</span><span class="n">Scalar</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">cv</span><span class="o">::</span><span class="n">imwrite</span><span class="p">(</span><span class="s">"output_yolov5.png"</span><span class="p">,</span><span class="w"> </span><span class="n">image</span><span class="p">);</span>

<span class="w">    </span><span class="n">Tend</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">steady_clock</span><span class="o">::</span><span class="n">now</span><span class="p">();</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">duration_cast</span><span class="w"> </span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">milliseconds</span><span class="o">&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">Tend</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Tbegin</span><span class="p">).</span><span class="n">count</span><span class="p">();</span>

<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">"draw objects time : "</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">" ms"</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p><a href="https://www.laumy.tech/wp-content/uploads/2025/05/wp_editor_md_e1d8da4bdb5dea095e1d2d5738dddf72.jpg"><img alt="" src="assets/doc/04-ai/ai应用/yolov5端侧部署代码分析/images/wp_editor_md_e1d8da4bdb5dea095e1d2d5738dddf72.jpg"/></a></p>
<h2 id="opencv">opencv参考函数</h2>
<div class="codehilite"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">cv::rectangle</span><span class="p">(</span>
<span class="w">    </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="o">&amp;</span><span class="w"> </span><span class="n">img</span><span class="p">,</span><span class="w">           </span><span class="c1">// 输入输出图像</span>
<span class="w">    </span><span class="n">cv</span><span class="o">::</span><span class="n">Rect</span><span class="w"> </span><span class="n">rec</span><span class="p">,</span><span class="w">           </span><span class="c1">// 矩形的位置和大小</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">Scalar</span><span class="o">&amp;</span><span class="w"> </span><span class="n">color</span><span class="p">,</span><span class="w"> </span><span class="c1">// 矩形的颜色（BGR格式）</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">thickness</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">      </span><span class="c1">// 矩形边框的厚度，默认是 1</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">lineType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">8</span><span class="p">,</span><span class="w">       </span><span class="c1">// 线条类型，默认为 8（抗锯齿线）</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">shift</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w">           </span><span class="c1">// 对坐标进行的位移，默认为 0</span>
<span class="p">);</span>

<span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">img</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">imread</span><span class="p">(</span><span class="s">"image.jpg"</span><span class="p">);</span><span class="w">  </span><span class="c1">// 读取图像</span>
<span class="n">cv</span><span class="o">::</span><span class="n">Rect</span><span class="w"> </span><span class="nf">rect</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span><span class="w"> </span><span class="mi">50</span><span class="p">,</span><span class="w"> </span><span class="mi">200</span><span class="p">,</span><span class="w"> </span><span class="mi">100</span><span class="p">);</span><span class="w">       </span><span class="c1">// 创建一个矩形，左上角为(50, 50)，宽200，高100</span>
<span class="n">cv</span><span class="o">::</span><span class="n">Scalar</span><span class="w"> </span><span class="nf">color</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">255</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w">           </span><span class="c1">// 设置矩形的颜色为绿色（BGR格式）</span>
<span class="n">cv</span><span class="o">::</span><span class="n">rectangle</span><span class="p">(</span><span class="n">img</span><span class="p">,</span><span class="w"> </span><span class="n">rect</span><span class="p">,</span><span class="w"> </span><span class="n">color</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span><span class="w">    </span><span class="c1">// 在图像上绘制绿色的矩形，边框厚度为2</span>
<span class="n">cv</span><span class="o">::</span><span class="n">imwrite</span><span class="p">(</span><span class="s">"output.jpg"</span><span class="p">,</span><span class="w"> </span><span class="n">img</span><span class="p">);</span><span class="w">        </span><span class="c1">// 保存图像</span>
</code></pre></div>
<ul>
<li>img: 输入和输出图像，矩形将被绘制在这张图像上。</li>
<li>rec: 这个矩形的坐标和尺寸，用 cv::Rect(x, y, width, height) 来指定矩形的位置（左上角 (x, y)）和尺寸（宽度和高度）。</li>
<li>color: 矩形边框的颜色，采用 cv::Scalar 类型表示颜色（BGR 格式），例如 cv::Scalar(255, 0, 0) 表示蓝色。</li>
<li>thickness: 边框的厚度。如果设置为负值（例如 -1），则矩形将会填充颜色，而不是只绘制边框。</li>
<li>lineType: 线条类型，决定了绘制线条的质量，常用的值有 8（8-connected lines）、4（4-connected lines），以及 CV_AA（抗锯齿线）。</li>
<li>shift: 表示坐标的位移，通常在进行精度处理时使用。</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">cv::putText</span><span class="p">(</span>
<span class="w">    </span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="o">&amp;</span><span class="w"> </span><span class="n">img</span><span class="p">,</span><span class="w">                   </span><span class="c1">// 输入输出图像</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">text</span><span class="p">,</span><span class="w">         </span><span class="c1">// 要绘制的文本</span>
<span class="w">    </span><span class="n">cv</span><span class="o">::</span><span class="n">Point</span><span class="w"> </span><span class="n">org</span><span class="p">,</span><span class="w">                  </span><span class="c1">// 文本的起始位置（左下角）</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">fontFace</span><span class="p">,</span><span class="w">                   </span><span class="c1">// 字体类型</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">fontScale</span><span class="p">,</span><span class="w">               </span><span class="c1">// 字体大小的缩放因子</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">Scalar</span><span class="o">&amp;</span><span class="w"> </span><span class="n">color</span><span class="p">,</span><span class="w">        </span><span class="c1">// 文本颜色（BGR格式）</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">thickness</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">              </span><span class="c1">// 字体线条的粗细，默认为 1</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">lineType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">8</span><span class="p">,</span><span class="w">               </span><span class="c1">// 线条类型，默认为 8</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">bottomLeftOrigin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="w">   </span><span class="c1">// 是否以左下角为原点，默认为 false</span>
<span class="p">);</span>

<span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="w"> </span><span class="n">img</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">imread</span><span class="p">(</span><span class="s">"image.jpg"</span><span class="p">);</span><span class="w">  </span><span class="c1">// 读取图像</span>
<span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"Hello, OpenCV!"</span><span class="p">;</span><span class="w">    </span><span class="c1">// 要绘制的文本</span>
<span class="n">cv</span><span class="o">::</span><span class="n">Point</span><span class="w"> </span><span class="nf">org</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span><span class="w"> </span><span class="mi">50</span><span class="p">);</span><span class="w">                  </span><span class="c1">// 文本的起始位置（左上角）</span>
<span class="n">cv</span><span class="o">::</span><span class="n">Scalar</span><span class="w"> </span><span class="nf">color</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">255</span><span class="p">);</span><span class="w">            </span><span class="c1">// 文本颜色为红色（BGR格式）</span>
<span class="kt">int</span><span class="w"> </span><span class="n">fontFace</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cv</span><span class="o">::</span><span class="n">FONT_HERSHEY_SIMPLEX</span><span class="p">;</span><span class="w"> </span><span class="c1">// 使用无衬线字体</span>
<span class="kt">double</span><span class="w"> </span><span class="n">fontScale</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span><span class="p">;</span><span class="w">                 </span><span class="c1">// 字体大小</span>
<span class="kt">int</span><span class="w"> </span><span class="n">thickness</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w">                      </span><span class="c1">// 字体粗细</span>

<span class="n">cv</span><span class="o">::</span><span class="n">putText</span><span class="p">(</span><span class="n">img</span><span class="p">,</span><span class="w"> </span><span class="n">text</span><span class="p">,</span><span class="w"> </span><span class="n">org</span><span class="p">,</span><span class="w"> </span><span class="n">fontFace</span><span class="p">,</span><span class="w"> </span><span class="n">fontScale</span><span class="p">,</span><span class="w"> </span><span class="n">color</span><span class="p">,</span><span class="w"> </span><span class="n">thickness</span><span class="p">);</span><span class="w"> </span><span class="c1">// 在图像上绘制文本</span>
<span class="n">cv</span><span class="o">::</span><span class="n">imwrite</span><span class="p">(</span><span class="s">"output_text.jpg"</span><span class="p">,</span><span class="w"> </span><span class="n">img</span><span class="p">);</span><span class="w">    </span><span class="c1">// 保存图像</span>
</code></pre></div>
<ul>
<li>img: 输入和输出图像，文本将被绘制在这张图像上。</li>
<li>text: 需要绘制的文本内容，使用 std::string 类型传递。</li>
<li>org: 文本的起始位置（左下角的坐标），使用 cv::Point(x, y) 形式来指定。</li>
<li>fontFace: 字体类型，OpenCV 提供了几种常见的字体类型：</li>
</ul>
<p>cv::FONT_HERSHEY_SIMPLEX：简单无衬线字体； cv::FONT_HERSHEY_PLAIN：简单的无衬线字体，字形更小； cv::FONT_HERSHEY_COMPLEX：复杂的无衬线字体； cv::FONT_HERSHEY_SCRIPT_SIMPLEX：手写体； cv::FONT_HERSHEY_SCRIPT_COMPLEX：复杂的手写体等。</p>
<ul>
<li>fontScale: 字体的缩放因子，用于调整字体大小。1.0 表示默认大小，2.0 表示更大。 color: 文本颜色，采用 cv::Scalar 类型表示颜色（BGR 格式），例如 cv::Scalar(255, 0, 0) 表示蓝色。</li>
<li>thickness: 字体的线条粗细，默认为 1。</li>
<li>lineType: 线条类型，决定了绘制文本时的线条质量，常见的有 8（8-connected lines）和 CV_AA（抗锯齿线）。</li>
<li>bottomLeftOrigin: 是否以左下角为原点。默认是 false，意味着文本是从左上角开始绘制的。如果设置为 true，则文本从左下角开始绘制</li>
</ul></div>
  <div class="post-nav">
    <a class="prev" href="transformer.html">← transformer</a>
    <a class="next" href="端侧部署yolov5模型.html">端侧部署YOLOv5模型 →</a>
  </div>
</article>

      </section>

      <aside class="right-panel">
        
      </aside>
    </main>

    <footer class="site-footer">
      <div class="container">Copyright ©2022-2025 laumy 版权所有</div>
    </footer>

    <script src="assets/site.js"></script>
  </body>
  </html>

