<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>视频编码示例 - Laumy的技术栈</title>
    <link rel="stylesheet" href="assets/style.css">
    <!-- MathJax支持LaTeX数学公式 -->
    <script>
      window.MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']],
          displayMath: [['$$', '$$'], ['\\[', '\\]']],
          processEscapes: true,
          processEnvironments: true
        },
        options: {
          ignoreHtmlClass: 'tex2jax_ignore',
          processHtmlClass: 'tex2jax_process'
        }
      };
    </script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  </head>
  <body>
    <header class="site-header">
      <div class="container">
        <a class="logo" href="">Laumy的技术栈</a>
        <div class="search">
          <input id="search-input" type="text" placeholder="输入关键词回车搜索">
        </div>
        <div class="theme-toggle" title="切换主题" id="theme-toggle">☾</div>
        <nav class="top-nav">
          <div class="nav-item"><a href="">首页</a></div>
        </nav>
      </div>
    </header>

    <main class="container layout">
      <aside class="left-nav">
        
        <div class="card">
          <div class="card-title">文章目录</div>
          <nav id="toc"><ul></ul></nav>
        </div>
        
      </aside>

      <section class="content">
        
<article class="card post">
  <h1>视频编码示例</h1>
  <div class="meta">2024-09-05 · linux</div>
  <div class="post-content"><div class="codehilite"><pre><span></span><code><span class="n">通路</span><span class="err">：</span><span class="n">CSI</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">ISP</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">VIPP</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">VirChn</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">VENC</span><span class="err">。</span>

<span class="n">CSI</span><span class="err">：</span><span class="n">表示物理</span><span class="w"> </span><span class="n">Camera</span><span class="w"> </span><span class="n">Signal</span><span class="w"> </span><span class="n">Input</span><span class="w"> </span><span class="n">Pasrse</span><span class="w"> </span><span class="n">Device</span><span class="w"> </span><span class="n">的接口</span><span class="err">。</span><span class="n">CSI</span><span class="w"> </span><span class="n">可以选择连接任意一个</span><span class="w"> </span><span class="n">ISP</span><span class="err">。</span><span class="n">最多支持</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="n">个</span><span class="w"> </span><span class="n">CSI</span><span class="err">。</span>
<span class="n">ISP</span><span class="err">：</span><span class="n">表示物理</span><span class="w"> </span><span class="n">ISP</span><span class="err">。</span><span class="n">ISP</span><span class="w"> </span><span class="n">可以选择连接任意多个</span><span class="w"> </span><span class="n">VIPP</span><span class="err">。</span><span class="n">最多支持</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="n">个</span><span class="w"> </span><span class="n">ISP</span><span class="err">。</span>
<span class="n">VIPP</span><span class="err">：</span><span class="n">表示物理</span><span class="w"> </span><span class="n">Scale</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">OSD</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Mask</span><span class="w"> </span><span class="n">通道</span><span class="err">。</span><span class="n">每个</span><span class="w"> </span><span class="n">VIPP</span><span class="w"> </span><span class="n">配合一个</span><span class="w"> </span><span class="n">DMA</span><span class="w"> </span><span class="n">输出一路</span><span class="w"> </span><span class="n">Video</span><span class="w"> </span><span class="n">给到</span><span class="w"> </span><span class="n">DDR</span><span class="err">。</span><span class="n">最多支持</span><span class="w"> </span><span class="mi">16</span><span class="w"> </span><span class="n">个</span><span class="w"> </span><span class="n">VIPP</span><span class="err">。</span>
<span class="n">VirChn</span><span class="err">：</span><span class="n">表示</span><span class="w"> </span><span class="n">VI</span><span class="w"> </span><span class="n">虚通道</span><span class="err">。</span><span class="n">每个物理通道最多虚拟</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="n">个虚通道输出</span><span class="err">。</span><span class="n">默认情况下推荐使用一个物理</span>
<span class="n">通道和一个虚通道来采集视频数据</span><span class="err">。</span><span class="n">虚拟通道的图像属性是物理通道的复制品</span><span class="err">。</span>
<span class="nl">VENC</span><span class="p">:</span><span class="n">编码通道</span><span class="err">，</span><span class="n">支持多路实时编码</span><span class="err">，</span><span class="n">且每路编码独立</span><span class="err">，</span><span class="n">编码协议和编码</span><span class="w"> </span><span class="n">pro</span><span class="err">‑</span><span class="n">file</span><span class="w"> </span><span class="n">可以不同</span><span class="err">。</span><span class="n">VENC</span><span class="w"> </span><span class="n">模块的输入源包括两类</span><span class="err">：</span><span class="n">用户态读取图像文件向编码模块发送数据</span><span class="err">；</span><span class="n">视频输入</span><span class="err">（</span><span class="n">VI</span><span class="err">）</span><span class="n">模块采集的图像直接发送到编码模块</span><span class="err">。</span>

<span class="n">CSI</span><span class="w"> </span><span class="n">输入设备</span><span class="err">，</span><span class="n">支持不同的时序输入</span><span class="err">，</span><span class="n">对输入的时序进行配置和解析</span><span class="err">。</span>
<span class="n">CSI</span><span class="err">、</span><span class="n">ISP</span><span class="err">、</span><span class="n">VIPP</span><span class="w"> </span><span class="n">数据处理不经过</span><span class="w"> </span><span class="n">DDR</span><span class="err">。</span><span class="w"> </span><span class="err">•</span><span class="w"> </span><span class="n">VIPP</span><span class="w"> </span><span class="n">设备号的使用</span><span class="err">，</span><span class="n">当前</span><span class="w"> </span><span class="n">ISP</span><span class="w"> </span><span class="n">默认是在线工作模式</span><span class="err">，</span><span class="n">故</span><span class="w"> </span><span class="n">VIPP</span><span class="w"> </span><span class="n">设备号</span><span class="w"> </span><span class="mi">0</span><span class="o">~</span><span class="mi">16</span><span class="w"> </span><span class="n">中</span><span class="err">，</span><span class="n">只能使用</span><span class="w"> </span><span class="mi">0</span><span class="err">、</span><span class="w"> </span><span class="mi">4</span><span class="err">、</span><span class="mi">8</span><span class="err">、</span><span class="mi">12</span><span class="err">。</span><span class="n">其中</span><span class="err">，</span><span class="n">只有</span><span class="w"> </span><span class="n">VIPP</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">支持在线编码</span><span class="err">。</span>
<span class="n">受硬件限制</span><span class="err">，</span><span class="n">只有前两个实体</span><span class="w"> </span><span class="n">VIPP</span><span class="w"> </span><span class="n">支持</span><span class="w"> </span><span class="n">LBC</span><span class="w"> </span><span class="n">压缩格式</span><span class="err">（</span><span class="n">对应</span><span class="w"> </span><span class="n">VIPP</span><span class="w"> </span><span class="n">设备号</span><span class="err">：</span><span class="mi">0</span><span class="err">、</span><span class="mi">4</span><span class="err">；</span><span class="mi">1</span><span class="err">、</span><span class="mi">5</span><span class="err">；</span><span class="mi">2</span><span class="err">、</span><span class="w"> </span><span class="mi">6</span><span class="err">；</span><span class="mi">3</span><span class="err">、</span><span class="mi">7</span><span class="err">），</span><span class="n">其他</span><span class="w"> </span><span class="n">VIPP</span><span class="w"> </span><span class="n">设备不支持</span><span class="w"> </span><span class="n">LBC</span><span class="w"> </span><span class="n">压缩格式</span><span class="err">。</span>

<span class="n">一</span><span class="err">、</span><span class="n">关键流程</span>

<span class="n">SAMPLE_VIRVI2VENC_S</span><span class="w"> </span><span class="o">*</span><span class="n">pContext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">SAMPLE_VIRVI2VENC_S</span><span class="o">*</span><span class="w"> </span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">SAMPLE_VIRVI2VENC_S</span><span class="p">))</span>
<span class="mf">1.</span><span class="w"> </span><span class="n">分配一个数据结构</span>

<span class="n">parseCmdLine</span><span class="p">(</span><span class="n">pContext</span><span class="p">,</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="n">argv</span><span class="p">)</span>
<span class="mf">2.</span><span class="w"> </span><span class="n">解析命令行</span>

<span class="n">loadConfigPara</span><span class="p">(</span><span class="n">pContext</span><span class="p">,</span><span class="w"> </span><span class="n">pConfPath</span><span class="p">)</span>
<span class="mf">3.</span><span class="n">加载配置文件</span><span class="err">，</span><span class="n">设置里面的参数</span>

<span class="n">AW_MPI_SYS_SetConf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mSysConf</span><span class="p">);</span>
<span class="mf">4.</span><span class="w"> </span><span class="n">设置配置参数</span>

<span class="n">AW_MPI_SYS_Init</span><span class="p">();</span>
<span class="mf">5.</span><span class="n">初始化</span>

<span class="n">prepare</span>
<span class="mf">6.</span><span class="w"> </span><span class="n">准备</span>
<span class="w">    </span><span class="n">createViChn</span>
<span class="w">    </span><span class="mf">6.1</span><span class="w"> </span><span class="n">创建VI通道</span>
<span class="w">        </span><span class="n">AW_MPI_VI_CreateVipp</span>
<span class="w">        </span><span class="mf">6.1.1</span><span class="w"> </span><span class="n">创建VIPP</span>

<span class="w">        </span><span class="n">AW_MPI_VI_SetVippAttr</span>
<span class="w">        </span><span class="mf">6.1.2</span><span class="w"> </span><span class="n">设置VIPP参数</span>

<span class="w">        </span><span class="n">AW_MPI_ISP_Run</span>
<span class="w">        </span><span class="mf">6.1.3</span><span class="w"> </span><span class="n">启动ISP</span>

<span class="w">        </span><span class="n">AW_MPI_VI_CreateVirChn</span>
<span class="w">        </span><span class="mf">6.1.4</span><span class="n">基于某个</span><span class="w"> </span><span class="n">VIPP</span><span class="err">，</span><span class="n">创建虚拟通道</span>

<span class="w">        </span><span class="n">AW_MPI_VI_EnableVipp</span>
<span class="w">        </span><span class="mf">6.1.5</span><span class="n">使能VIPP</span>

<span class="w">    </span><span class="n">createVencChn</span>
<span class="w">    </span><span class="mf">6.2</span><span class="n">创建编码通道</span>
<span class="w">        </span><span class="n">AW_MPI_VENC_CreateChn</span>
<span class="w">        </span><span class="mf">6.2.1</span><span class="w"> </span><span class="n">创建一个编码通道</span><span class="err">，</span><span class="n">同时配置编码通道属性</span>

<span class="w">        </span><span class="n">AW_MPI_VENC_SetRcParam</span>
<span class="w">        </span><span class="mf">6.2.2</span><span class="n">设置编码速率控制参考参数</span>

<span class="w">        </span><span class="n">AW_MPI_VENC_Set2DFilter</span>
<span class="w">        </span><span class="mf">6.2.3</span><span class="w"> </span><span class="n">设置</span><span class="w"> </span><span class="mi">2</span><span class="n">D</span><span class="w"> </span><span class="n">降噪高级参数</span>

<span class="w">        </span><span class="n">AW_MPI_VENC_Set3DFilter</span>
<span class="w">        </span><span class="mf">6.2.4</span><span class="w"> </span><span class="n">设置3D降噪参数</span>

<span class="w">        </span><span class="n">AW_MPI_VENC_SetColor2Grey</span>
<span class="w">        </span><span class="mf">6.2.5</span><span class="w"> </span><span class="n">开启或关闭一个通道的彩转灰功能</span>

<span class="w">        </span><span class="n">AW_MPI_VENC_SetHorizonFlip</span>
<span class="w">        </span><span class="mf">6.2.6</span><span class="w"> </span><span class="n">设置编码水平镜像</span><span class="err">。</span>

<span class="w">        </span><span class="n">AW_MPI_VENC_SetCrop</span>
<span class="w">        </span><span class="mf">6.2.7</span><span class="w"> </span><span class="n">设置编码通道编码裁剪区域</span>

<span class="w">        </span><span class="n">AW_MPI_VENC_SetIntraRefresh</span>
<span class="w">        </span><span class="mf">6.2.8</span><span class="w"> </span><span class="n">P</span><span class="w"> </span><span class="n">帧帧内刷新</span><span class="err">。</span><span class="n">设置刷</span><span class="w"> </span><span class="n">I</span><span class="w"> </span><span class="n">宏块的参数</span>

<span class="w">        </span><span class="n">AW_MPI_VENC_SetSmartP</span>
<span class="w">        </span><span class="mf">6.2.9</span><span class="w"> </span><span class="n">设置</span><span class="w"> </span><span class="n">P</span><span class="w"> </span><span class="n">帧</span><span class="w"> </span><span class="n">smart</span><span class="w"> </span><span class="n">编码参数</span>

<span class="w">        </span><span class="n">AW_MPI_VENC_SetH264SVCSkip</span>
<span class="w">        </span><span class="mf">6.2.10</span><span class="w"> </span><span class="n">设置时域可伸缩编码及跳帧</span><span class="err">。</span><span class="n">注意不能与插帧混用</span>

<span class="w">        </span><span class="n">AW_MPI_VENC_SetH264Vui</span>
<span class="w">        </span><span class="mf">6.2.11</span><span class="w"> </span><span class="n">设置</span><span class="w"> </span><span class="n">H264</span><span class="w"> </span><span class="n">VUI</span><span class="w"> </span><span class="n">参数</span><span class="err">。</span><span class="n">主要包括帧率等</span>

<span class="w">        </span><span class="n">AW_MPI_VENC_SetH264NalRefIdcNoneZeroValue</span>
<span class="w">        </span><span class="mf">6.2.12</span><span class="w"> </span>

<span class="w">        </span><span class="n">AW_MPI_VENC_SetSuperFrameCfg</span>
<span class="w">        </span><span class="mf">6.2.13</span><span class="w"> </span><span class="n">设置超大帧重编码处理参数</span>

<span class="w">        </span><span class="n">AW_MPI_VENC_SetChromaQPOffset</span>
<span class="w">        </span><span class="mf">6.2.14</span><span class="w"> </span><span class="n">设置色度</span><span class="w"> </span><span class="n">QP</span><span class="w"> </span><span class="n">的偏移</span><span class="err">。</span>

<span class="w">        </span><span class="n">AW_MPI_VENC_SetH264ConstraintFlag</span>
<span class="w">        </span><span class="mf">6.2.15</span><span class="w"> </span><span class="n">设置</span><span class="w"> </span><span class="n">H264</span><span class="w"> </span><span class="n">编码的约束标志</span>

<span class="w">         </span><span class="n">AW_MPI_VENC_SetVe2IspD2DLimit</span>
<span class="w">        </span><span class="mf">6.2.16</span><span class="w"> </span><span class="n">设置</span><span class="w"> </span><span class="n">ve</span><span class="w"> </span><span class="n">到</span><span class="w"> </span><span class="n">isp</span><span class="w"> </span><span class="n">的</span><span class="w"> </span><span class="n">D2D</span><span class="w"> </span><span class="n">限制</span>

<span class="w">        </span><span class="n">AW_MPI_VENC_SetVbrOptParam</span>
<span class="w">        </span><span class="mf">6.2.17</span>

<span class="w">        </span><span class="n">AW_MPI_VENC_RegisterCallback</span>
<span class="w">        </span><span class="mf">6.2.18</span><span class="w"> </span><span class="n">设置编码的回调</span>

<span class="w">        </span><span class="n">AW_MPI_VENC_EnableIspVeLink</span>
<span class="w">        </span><span class="mf">6.2.19</span><span class="w"> </span><span class="n">xxx</span>

<span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pthread_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mThreadId</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">GetEncoderFrameThread</span><span class="p">,</span><span class="w"> </span><span class="n">pContext</span><span class="p">);</span>
<span class="mf">7.</span><span class="w"> </span><span class="n">创建一个线程获取流</span>

<span class="n">start</span>
<span class="mf">8.</span><span class="w"> </span><span class="n">启动</span>

<span class="w">    </span><span class="n">AW_MPI_VI_EnableVirChn</span>
<span class="w">    </span><span class="mf">8.1</span><span class="w"> </span><span class="n">启动虚拟通道</span><span class="p">,</span><span class="n">可以设置多个输出通道</span>

<span class="w">    </span><span class="n">AW_MPI_VENC_StartRecvPic</span>
<span class="w">    </span><span class="mf">8.2</span><span class="w"> </span><span class="n">启动编码</span>

<span class="w">    </span><span class="n">AW_MPI_VENC_GetMBSuminfo</span>
<span class="w">    </span><span class="mf">8.3</span><span class="w"> </span><span class="n">打开</span><span class="w"> </span><span class="n">MB</span><span class="err">（</span><span class="n">宏块</span><span class="err">）</span><span class="n">统计信息功能</span>

<span class="n">AW_MPI_VENC_SetRoiCfg</span><span class="p">(</span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mVeChn</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">stMppRoiBlockInfo</span><span class="p">)</span>
<span class="mf">9.</span><span class="w"> </span><span class="n">ROI配置</span>

<span class="n">AW_MPI_VENC_GetRoiBgFrameRate</span><span class="p">(</span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mVeChn</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">stRoiBgFrmRate</span><span class="p">);</span>
<span class="mf">10.</span><span class="n">获取感兴趣区域编码的背景帧率</span>

<span class="n">AW_MPI_VENC_SetRoiBgFrameRate</span><span class="p">(</span><span class="n">pContext</span><span class="o">-&gt;</span><span class="n">mVeChn</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">stRoiBgFrmRate</span><span class="p">)</span>
<span class="mf">11.</span><span class="n">设置感兴趣背景帧率</span>

<span class="n">AW_MPI_RGN_Create</span>
<span class="mf">12.</span><span class="w"> </span><span class="n">创建区域</span>

<span class="n">AW_MPI_RGN_AttachToChn</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">viChn</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">stRgnChnAttr</span><span class="p">)</span>
<span class="mf">13.</span><span class="w"> </span><span class="n">将区域叠加到通道上</span>

<span class="n">AW_MPI_RGN_Destroy</span>
<span class="mf">14.</span><span class="w"> </span><span class="n">销毁区域</span>

<span class="n">stop</span>
<span class="mf">15.</span><span class="w"> </span><span class="n">停止</span>

<span class="w">    </span><span class="n">AW_MPI_VI_DisableVirChn</span>
<span class="w">    </span><span class="mf">15.1</span><span class="w"> </span><span class="n">关闭虚拟通道</span>

<span class="w">    </span><span class="n">AW_MPI_VENC_StopRecvPic</span>
<span class="w">    </span><span class="mf">15.2</span><span class="w"> </span><span class="n">停止编码</span>

<span class="w">    </span><span class="n">AW_MPI_VENC_DestroyChn</span>
<span class="w">    </span><span class="mf">15.3</span><span class="w"> </span><span class="n">销毁一个编码通道</span>

<span class="w">    </span><span class="n">AW_MPI_VI_DestroyVirChn</span>
<span class="w">    </span><span class="mf">15.4</span><span class="w"> </span><span class="n">销毁指定</span><span class="w"> </span><span class="n">VIPP</span><span class="w"> </span><span class="n">设备的指定虚拟通道</span>

<span class="w">    </span><span class="n">AW_MPI_ISP_Stop</span>
<span class="w">    </span><span class="mf">15.5</span><span class="w"> </span><span class="n">销毁ISP</span>

<span class="w">    </span><span class="n">AW_MPI_VI_DisableVipp</span>
<span class="w">    </span><span class="mf">15.3</span><span class="w"> </span><span class="n">禁用vipp物理设备</span>

<span class="n">二</span><span class="err">、</span><span class="n">关键取流</span>

<span class="n">AW_MPI_VENC_GetH264SpsPpsInfo</span>
<span class="mf">1.</span><span class="w"> </span><span class="n">获取sps</span><span class="w"> </span><span class="n">pps信息</span>

<span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="w">    </span><span class="n">AW_MPI_VENC_GetStream</span><span class="p">(</span><span class="n">nVencChn</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">VencFrame</span><span class="p">,</span><span class="w"> </span><span class="mi">4000</span><span class="p">)</span>
<span class="w">    </span><span class="mf">2.</span><span class="w"> </span><span class="n">获取编码后的码流</span><span class="err">，</span><span class="n">最后一个参数会超时时间</span><span class="err">。</span>

<span class="w">    </span><span class="n">AW_MPI_VENC_ReleaseStream</span>
<span class="w">    </span><span class="mf">3.</span><span class="w"> </span><span class="n">释放编码后的码流</span>
</code></pre></div></div>
  <div class="post-nav">
    <a class="prev" href="系统死机排查思路.html">← 系统死机排查思路</a>
    <a class="next" href="内存地址对齐.html">内存地址对齐 →</a>
  </div>
</article>

      </section>

      <aside class="right-panel">
        
      </aside>
    </main>

    <footer class="site-footer">
      <div class="container">Copyright ©2022-2025 laumy 版权所有</div>
    </footer>

    <script src="assets/site.js"></script>
  </body>
  </html>

