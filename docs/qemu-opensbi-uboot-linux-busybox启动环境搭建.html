<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>qemu+opensbi+uboot+linux+busybox启动环境搭建 - Laumy的技术栈</title>
    <link rel="stylesheet" href="/assets/style.css">
    <!-- MathJax支持LaTeX数学公式 -->
    <script>
      window.MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']],
          displayMath: [['$$', '$$'], ['\\[', '\\]']],
          processEscapes: true,
          processEnvironments: true
        },
        options: {
          ignoreHtmlClass: 'tex2jax_ignore',
          processHtmlClass: 'tex2jax_process'
        }
      };
    </script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  </head>
  <body>
    <header class="site-header">
      <div class="container">
        <a class="logo" href="/">Laumy的技术栈</a>
        <div class="search">
          <input id="search-input" type="text" placeholder="输入关键词回车搜索">
        </div>
        <div class="theme-toggle" title="切换主题" id="theme-toggle">☾</div>
        <nav class="top-nav">
          <div class="nav-item"><a href="/">首页</a></div>
        </nav>
      </div>
    </header>

    <main class="container layout">
      <aside class="left-nav">
        
        <div class="card">
          <div class="card-title">文章目录</div>
          <nav id="toc"><ul><li><a href="#_1">前置条件</a><ul><li><a href="#qemu">qemu+工具链安装</a></li><li><a href="#_2">代码下载</a></li></ul></li><li><a href="#opensbi">编译opensbi</a><ul></ul></li><li><a href="#uboot">编译uboot</a><ul></ul></li><li><a href="#linux">编译linux</a><ul></ul></li><li><a href="#busybox">编译busybox</a><ul></ul></li><li><a href="#_3">制作根文件系统</a><ul></ul></li><li><a href="#_4">启动内核</a><ul></ul></li><li><a href="#qemu_1">qemu虚拟机和宿主机传输文件</a><ul></ul></li></ul></nav>
        </div>
        
      </aside>

      <section class="content">
        
<article class="card post">
  <h1>qemu+opensbi+uboot+linux+busybox启动环境搭建</h1>
  <div class="meta">2024-05-14 · risc-v</div>
  <div class="post-content"><h2 id="_1">前置条件</h2>
<h3 id="qemu">qemu+工具链安装</h3>
<p>安装好交叉编译工具链和qemu环境，参考：<a href="https://www.laumy.tech/1127.html#risc-v64_Xuantie">https://www.laumy.tech/1127.html#risc-v64_Xuantie</a></p>
<h3 id="_2">代码下载</h3>
<ul>
<li>opensbi：[version: v1.2](https://gitee.com/tinylab/qemu-opensbi \"version: v1.2\")</li>
<li>uboot: [version: v2022.04](https://gitee.com/mirrors/u-boot \"v2022.04\")</li>
<li>kernel: [version: v5.18](https://gitee.com/mirrors/linux_old1 \"version: v5.18\")</li>
<li>busybox:[ version: v1.37.0.git](https://gitee.com/mirrors/busyboxsource \" version: v1.37.0.git\")</li>
</ul>
<h2 id="opensbi">编译opensbi</h2>
<div class="codehilite"><pre><span></span><code><span class="n">export</span><span class="w"> </span><span class="n">CROSS_COMPILE</span><span class="o">=</span><span class="n">riscv64</span><span class="o">-</span><span class="n">unknown</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="o">-</span>
<span class="n">make</span><span class="w"> </span><span class="n">all</span><span class="w"> </span><span class="n">PLATFORM</span><span class="o">=</span><span class="n">generic</span><span class="w"> </span><span class="n">PLATFORM_RISCV_XLEN</span><span class="o">=</span><span class="mi">64</span>

<span class="nl">bin路径</span><span class="p">:</span><span class="n">build</span><span class="o">/</span><span class="n">platform</span><span class="o">/</span><span class="n">generic</span><span class="o">/</span><span class="n">firmware</span><span class="o">/</span><span class="n">fw_jump</span><span class="p">.</span><span class="n">bin</span>
</code></pre></div>
<h2 id="uboot">编译uboot</h2>
<div class="codehilite"><pre><span></span><code><span class="n">export</span><span class="w"> </span><span class="n">CROSS_COMPILE</span><span class="o">=</span><span class="n">riscv64</span><span class="o">-</span><span class="n">unknown</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="o">-</span>
<span class="n">make</span><span class="w"> </span><span class="n">qemu</span><span class="o">-</span><span class="n">riscv64_smode_defconfig</span>
<span class="n">make</span><span class="w"> </span><span class="o">-</span><span class="n">j</span><span class="w"> </span><span class="mi">2</span>
</code></pre></div>
<p>适用默认qemu自带的opensbi，引导uboot镜像</p>
<div class="codehilite"><pre><span></span><code><span class="n">cd</span><span class="w"> </span><span class="n">uboot</span>

<span class="n">qemu</span><span class="o">-</span><span class="n">system</span><span class="o">-</span><span class="n">riscv64</span><span class="w"> </span><span class="o">-</span><span class="n">M</span><span class="w"> </span><span class="n">virt</span><span class="w"> </span><span class="o">-</span><span class="n">smp</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="o">-</span><span class="n">m</span><span class="w"> </span><span class="mi">2</span><span class="n">G</span><span class="w"> </span><span class="err">\</span>\
<span class="w"> </span><span class="o">-</span><span class="n">display</span><span class="w"> </span><span class="n">none</span><span class="w"> </span><span class="o">-</span><span class="n">serial</span><span class="w"> </span><span class="n">stdio</span><span class="w"> </span><span class="o">-</span><span class="n">kernel</span><span class="w"> </span><span class="n">u</span><span class="o">-</span><span class="n">boot</span><span class="p">.</span><span class="n">bin</span>
</code></pre></div>
<p>使用自行编译的opensbi进行引导uboot，需要在OpenSBI 编译时指定 U-Boot的路径，如下：</p>
<div class="codehilite"><pre><span></span><code><span class="n">cd</span><span class="w"> </span><span class="p">..</span><span class="o">/</span><span class="n">qemu</span><span class="o">-</span><span class="n">opensbi</span>

<span class="n">export</span><span class="w"> </span><span class="n">CROSS_COMPILE</span><span class="o">=</span><span class="n">riscv64</span><span class="o">-</span><span class="n">unknown</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="o">-</span>

<span class="n">make</span><span class="w"> </span><span class="n">PLATFORM</span><span class="o">=</span><span class="n">generic</span><span class="w"> </span><span class="n">FW_PAYLOAD_PATH</span><span class="o">=</span><span class="p">..</span><span class="o">/</span><span class="n">u</span><span class="o">-</span><span class="n">boot</span><span class="o">-</span><span class="n">v2022</span><span class="mf">.04</span><span class="o">/</span><span class="n">u</span><span class="o">-</span><span class="n">boot</span><span class="p">.</span><span class="n">bin</span>
</code></pre></div>
<p>编译完成后运行</p>
<div class="codehilite"><pre><span></span><code><span class="n">qemu</span><span class="o">-</span><span class="n">system</span><span class="o">-</span><span class="n">riscv64</span><span class="w"> </span><span class="o">-</span><span class="n">M</span><span class="w"> </span><span class="n">virt</span><span class="w"> </span><span class="o">-</span><span class="n">m</span><span class="w"> </span><span class="mi">256</span><span class="n">M</span><span class="w"> </span><span class="o">-</span><span class="n">nographic</span><span class="w"> </span><span class="err">\</span>\
<span class="w"> </span><span class="o">-</span><span class="n">bios</span><span class="w"> </span><span class="n">qemu</span><span class="o">-</span><span class="n">opensbi</span><span class="o">/</span><span class="n">build</span><span class="o">/</span><span class="n">platform</span><span class="o">/</span><span class="n">generic</span><span class="o">/</span><span class="n">firmware</span><span class="o">/</span><span class="n">fw_payload</span><span class="p">.</span><span class="n">elf</span>
</code></pre></div>
<h2 id="linux">编译linux</h2>
<div class="codehilite"><pre><span></span><code><span class="n">cd</span><span class="w"> </span><span class="n">linux</span><span class="mf">-5.18</span><span class="o">/</span>
<span class="n">make</span><span class="w"> </span><span class="n">ARCH</span><span class="o">=</span><span class="n">riscv</span><span class="w"> </span><span class="n">CROSS_COMPILE</span><span class="o">=</span><span class="n">riscv64</span><span class="o">-</span><span class="n">unknown</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="o">-</span><span class="w"> </span><span class="n">defconfig</span>
<span class="n">make</span><span class="w"> </span><span class="n">ARCH</span><span class="o">=</span><span class="n">riscv</span><span class="w"> </span><span class="n">CROSS_COMPILE</span><span class="o">=</span><span class="n">riscv64</span><span class="o">-</span><span class="n">unknown</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="o">-</span><span class="w"> </span><span class="o">-</span><span class="n">j</span><span class="w"> </span><span class="mi">48</span>

<span class="n">固件生成</span><span class="err">：</span><span class="n">arch</span><span class="o">/</span><span class="n">riscv</span><span class="o">/</span><span class="n">boot</span><span class="o">/</span><span class="n">Image</span>
</code></pre></div>
<h2 id="busybox">编译busybox</h2>
<div class="codehilite"><pre><span></span><code><span class="n">cd</span><span class="w"> </span><span class="n">busyboxsource</span>
<span class="n">export</span><span class="w"> </span><span class="n">CROSS_COMPILE</span><span class="o">=</span><span class="n">riscv64</span><span class="o">-</span><span class="n">unknown</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="o">-</span>
<span class="n">make</span><span class="w"> </span><span class="n">defconfig</span>
<span class="n">make</span><span class="w"> </span><span class="n">menuconfig</span>
<span class="w"> </span><span class="n">Settings</span><span class="o">--&gt;</span><span class="n">Build</span><span class="w"> </span><span class="n">Options</span><span class="w"> </span>
<span class="w">    </span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="w"> </span><span class="n">Build</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="n">binary</span><span class="w"> </span><span class="p">(</span><span class="n">no</span><span class="w"> </span><span class="n">shared</span><span class="w"> </span><span class="n">libs</span><span class="p">)</span><span class="w"> </span><span class="o">---</span><span class="n">使能</span><span class="err">，</span><span class="n">这样就不用拷贝lib</span>

<span class="n">make</span><span class="w"> </span><span class="o">-</span><span class="n">j</span><span class="w"> </span><span class="mi">48</span>
<span class="n">make</span><span class="w"> </span><span class="n">install</span>

<span class="n">编译生成的命令</span><span class="err">：</span><span class="n">_install</span>
</code></pre></div>
<h2 id="_3">制作根文件系统</h2>
<div class="codehilite"><pre><span></span><code><span class="n">cd</span><span class="w"> </span><span class="p">..</span><span class="o">/</span>
<span class="n">qemu</span><span class="o">-</span><span class="n">img</span><span class="w"> </span><span class="n">create</span><span class="w"> </span><span class="n">rootfs</span><span class="p">.</span><span class="n">img</span><span class="w"> </span><span class="mi">1</span><span class="n">g</span><span class="w">   </span><span class="o">---</span><span class="n">创建一个文件</span>
<span class="n">mkfs</span><span class="p">.</span><span class="n">ext4</span><span class="w"> </span><span class="n">rootfs</span><span class="p">.</span><span class="n">img</span><span class="w">            </span><span class="o">---</span><span class="n">将文件格式为ext4格式</span>
<span class="n">mkdir</span><span class="w"> </span><span class="n">rootfs</span>
<span class="n">sudo</span><span class="w"> </span><span class="n">mount</span><span class="w"> </span><span class="o">-</span><span class="n">o</span><span class="w"> </span><span class="n">loop</span><span class="w"> </span><span class="n">rootfs</span><span class="p">.</span><span class="n">img</span><span class="w"> </span><span class="n">rootfs</span><span class="w">  </span><span class="o">---</span><span class="n">挂在文件到rootfs下</span><span class="err">，</span><span class="n">将命令等拷贝进去</span>
<span class="n">cd</span><span class="w"> </span><span class="n">rootfs</span>
<span class="n">sudo</span><span class="w"> </span><span class="n">cp</span><span class="w"> </span><span class="o">-</span><span class="n">r</span><span class="w"> </span><span class="p">..</span><span class="o">/</span><span class="n">busyboxsource</span><span class="o">/</span><span class="n">_install</span><span class="cm">/* .</span>
<span class="cm">sudo mkdir proc sys dev etc etc/init.d</span>
<span class="cm">cd etc/init.d/</span>
<span class="cm">sudo touch rcS</span>
<span class="cm">sudo vi rcS</span>

<span class="cm">如果要执行要进行交叉编译把库文件拷贝进去</span>
<span class="cm">cp -rf Xuantie-900-gcc-linux-5.10.4-glibc-x86_64-V2.8.1/sysroot/lib* .</span>
</code></pre></div>
<p>rcS文件内容如下：</p>
<div class="codehilite"><pre><span></span><code><span class="cp">#!/bin/sh</span>
<span class="n">mount</span><span class="w"> </span><span class="o">-</span><span class="n">t</span><span class="w"> </span><span class="n">proc</span><span class="w"> </span><span class="n">none</span><span class="w"> </span><span class="o">/</span><span class="n">proc</span>
<span class="n">mount</span><span class="w"> </span><span class="o">-</span><span class="n">t</span><span class="w"> </span><span class="n">sysfs</span><span class="w"> </span><span class="n">none</span><span class="w"> </span><span class="o">/</span><span class="n">sys</span>
<span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">mdev</span><span class="w"> </span><span class="o">-</span><span class="n">s</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code><span class="n">sudo</span><span class="w"> </span><span class="n">chmod</span><span class="w"> </span><span class="o">+</span><span class="n">x</span><span class="w"> </span><span class="n">rcS</span>
<span class="n">cd</span><span class="w"> </span><span class="o">~</span>
<span class="n">sudo</span><span class="w"> </span><span class="n">umount</span><span class="w"> </span><span class="n">rootfs</span>
</code></pre></div>
<h2 id="_4">启动内核</h2>
<div class="codehilite"><pre><span></span><code><span class="cp">#!/bin/sh</span>

<span class="n">qemu</span><span class="o">-</span><span class="n">system</span><span class="o">-</span><span class="n">riscv64</span><span class="w"> </span><span class="o">-</span><span class="n">M</span><span class="w"> </span><span class="n">virt</span><span class="w"> </span><span class="o">-</span><span class="n">cpu</span><span class="w"> </span><span class="n">c910v</span><span class="w"> </span><span class="o">-</span><span class="n">m</span><span class="w"> </span><span class="mi">256</span><span class="n">M</span><span class="w"> </span><span class="o">-</span><span class="n">nographic</span><span class="w"> </span><span class="err">\</span>\
<span class="w"> </span><span class="o">-</span><span class="n">bios</span><span class="w"> </span><span class="n">qemu</span><span class="o">-</span><span class="n">opensbi</span><span class="o">/</span><span class="n">build</span><span class="o">/</span><span class="n">platform</span><span class="o">/</span><span class="n">generic</span><span class="o">/</span><span class="n">firmware</span><span class="o">/</span><span class="n">fw_jump</span><span class="p">.</span><span class="n">bin</span><span class="w"> </span><span class="err">\</span>\
<span class="w"> </span><span class="o">-</span><span class="n">kernel</span><span class="w"> </span><span class="n">linux</span><span class="mf">-5.18</span><span class="o">/</span><span class="n">arch</span><span class="o">/</span><span class="n">riscv</span><span class="o">/</span><span class="n">boot</span><span class="o">/</span><span class="n">Image</span><span class="w"> </span><span class="err">\</span>\
<span class="w"> </span><span class="o">-</span><span class="n">drive</span><span class="w"> </span><span class="n">file</span><span class="o">=</span><span class="n">rootfs</span><span class="p">.</span><span class="n">img</span><span class="p">,</span><span class="n">format</span><span class="o">=</span><span class="n">raw</span><span class="p">,</span><span class="n">id</span><span class="o">=</span><span class="n">hd0</span><span class="w">  </span><span class="err">\</span>\
<span class="w"> </span><span class="o">-</span><span class="n">device</span><span class="w"> </span><span class="n">virtio</span><span class="o">-</span><span class="n">blk</span><span class="o">-</span><span class="n">device</span><span class="p">,</span><span class="n">drive</span><span class="o">=</span><span class="n">hd0</span><span class="w"> </span><span class="err">\</span>\
<span class="w"> </span><span class="o">-</span><span class="n">append</span><span class="w"> </span><span class="err">\</span><span class="s">"root=/dev/vda rw console=ttyS0</span><span class="se">\"</span>
</code></pre></div>
<p><a href="https://www.laumy.tech/wp-content/uploads/2024/05/wp_editor_md_9904e694a17356e4682f1c5d66baaad0.jpg"><img alt="" src="/assets/doc/02-risc-v/qemuopensbiubootlinuxbusybox启动环境搭建/images/wp_editor_md_9904e694a17356e4682f1c5d66baaad0.jpg"/></a></p>
<h2 id="qemu_1">qemu虚拟机和宿主机传输文件</h2>
<p>qemu启动参数加上下面命令</p>
<div class="codehilite"><pre><span></span><code><span class="o">-</span><span class="n">virtfs</span><span class="w"> </span><span class="n">local</span><span class="p">,</span><span class="n">path</span><span class="o">=/</span><span class="n">mnt</span><span class="o">/</span><span class="n">shared</span><span class="p">,</span><span class="n">mount_tag</span><span class="o">=</span><span class="n">host0</span><span class="p">,</span><span class="n">security_model</span><span class="o">=</span><span class="n">passthrough</span><span class="p">,</span><span class="n">id</span><span class="o">=</span><span class="n">host0</span>
</code></pre></div>
<ul>
<li>-virtfs选项指定了共享文件夹的参数</li>
<li>local表示共享文件夹是本地文件夹</li>
<li>path指定了共享文件夹的路径</li>
<li>mount_tag指定了共享文件夹在虚拟机中的挂载点</li>
<li>security_model”指定了安全模型</li>
<li>id是共享文件夹的标识符。</li>
</ul>
<p>宿主机执行</p>
<div class="codehilite"><pre><span></span><code><span class="n">mkdir</span><span class="w"> </span><span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="n">shared</span>
<span class="n">mount</span><span class="w"> </span><span class="o">-</span><span class="n">t</span><span class="w"> </span><span class="mi">9</span><span class="n">p</span><span class="w"> </span><span class="o">-</span><span class="n">o</span><span class="w"> </span><span class="n">trans</span><span class="o">=</span><span class="n">virtio</span><span class="p">,</span><span class="n">version</span><span class="o">=</span><span class="mi">9</span><span class="n">p2000</span><span class="p">.</span><span class="n">L</span><span class="w"> </span><span class="n">host0</span><span class="w"> </span><span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="n">shared</span>
</code></pre></div>
<p>本文参考：[tinylab:YJMSTR](https://gitee.com/tinylab/riscv-linux/blob/master/articles/20220816-introduction-to-qemu-and-riscv-upstream-boot-flow.md#https://gitee.com/link?target=https%3A%2F%2Ftinylab.org%2Friscv-uefi-part1%2F \"tinylab:YJMSTR\")</p></div>
  <div class="post-nav">
    <a class="prev" href="/opensbi分析-一.html">← opensbi分析（一）</a>
    <a class="next" href="/risc-v架构与freertos任务栈变化.html">RISC-V架构与FreeRTOS任务栈变化 →</a>
  </div>
</article>

      </section>

      <aside class="right-panel">
        
      </aside>
    </main>

    <footer class="site-footer">
      <div class="container">Copyright ©2022-2025 laumy 版权所有</div>
    </footer>

    <script src="/assets/site.js"></script>
  </body>
  </html>

